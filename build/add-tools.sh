#!/bin/bash
#######################################
# Handle the installation of tools
#######################################
#####
# Flag is used to build a version of the image with components that 
# are not normally useful in a web assessment context.
# This can happen in a context of an assessment using compromised container posture.
INSTALL_EXTRA_SOFTWARE_AND_PACKAGES="YES"
echo "[i] INSTALL_EXTRA_SOFTWARE_AND_PACKAGES flag set to '$INSTALL_EXTRA_SOFTWARE_AND_PACKAGES'."
#####
# Create a Python virtual to address PEP668 error
# See https://peps.python.org/pep-0668/
# See https://github.com/python/cpython/issues/102134
cd /root
python -m venv pyenv
chmod -R +x pyenv
source pyenv/bin/activate
which python
python -m pip install --upgrade pip
# Add Python modules used by almost all custom scripts as well as technical foundation ones
python -m pip install wheel requests pipreqs termcolor colorama tabulate tqdm ansi2html jsbeautifier dicttoxml importlib_metadata
# Create the share folder
mkdir /tools/reports
# Ones via GIT repository cloning with sometimes local compilation/install commands
git clone --depth 1 https://github.com/maurosoria/dirsearch.git /tools/dirsearch
git clone --depth 1 https://github.com/drwetter/testssl.sh /tools/testssl
git clone --depth 1 https://github.com/sullo/nikto.git /tools/nikto
git clone --depth 1 https://github.com/danielmiessler/SecLists.git /tools/sec-lists
git clone --depth 1 https://github.com/stamparm/identYwaf.git /tools/identYwaf
git clone --depth 1 https://github.com/righettod/website-passive-reconnaissance.git /tools/website-passive-reconnaissance
git clone --depth 1 https://github.com/sqlmapproject/sqlmap.git /tools/sqlmap
git clone --depth 1 https://github.com/no0be/vhost-brute.sh.git /tools/vhost-brute
git clone --depth 1 https://github.com/infodox/python-pty-shells.git /tools/python-pty-shells
git clone --depth 1 https://github.com/rebootuser/LinEnum.git /tools/privesc-linux-enumeration
git clone --depth 1 https://github.com/mzet-/linux-exploit-suggester.git /tools/exploit-suggester-linux
git clone --depth 1 https://github.com/bitsadmin/wesng.git /tools/exploit-suggester-windows
git clone --depth 1 https://github.com/samratashok/nishang.git /tools/offensive-powershell-scripts
git clone --depth 1 https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite.git /tools/privesc-awesome-scripts-suite
git clone --depth 1 https://github.com/abdulfatir/ZipBomb.git /tools/zip-bomb-generator
git clone --depth 1 https://github.com/digininja/RSMangler.git /tools/password-mangler
git clone --depth 1 https://github.com/jonaslejon/malicious-pdf.git /tools/malicious-pdf-generator
git clone https://github.com/arno-di-loreto/jq-and-openapi.git /tools/jq-openapi-filters-collection
cd /tools/jq-openapi-filters-collection
git pull --all
git clone --depth 1 https://github.com/internetwache/GitTools.git /tools/git-repo-recovery-toolkit
git clone --depth 1 https://github.com/dolevf/graphw00f.git /tools/graphw00f
git clone --depth 1 https://github.com/NickstaDB/xamarin-decompress.git /tools/xamarin-decompress
git clone --depth 1 https://github.com/floyd-fuh/JKS-private-key-cracker-hashcat.git /tools/prepare-jks-for-hashcat-cracking
git clone --depth 1 https://github.com/nccgroup/nmap-nse-vulnerability-scripts.git /tools/nccgroup-nmap-nse-scripts
git clone --depth 1 https://github.com/drwetter/F5-BIGIP-Decoder.git /tools/bigip-decoder
git clone --depth 1 https://github.com/cisagov/log4j-scanner.git /tools/log4shell-scanner
git clone --depth 1 https://github.com/t3l3machus/psudohash.git /tools/password-derivation
git clone --depth 1 https://github.com/projectdiscovery/fuzzing-templates.git /tools/nuclei-fuzzing-templates
git clone --depth 1 https://github.com/iknowjason/edge.git /tools/edge
cd /tools/edge
go build edge.go
git clone --depth 1 https://github.com/blechschmidt/massdns.git /tools/massdns
cd /tools/massdns
make
make install
git clone --depth 1 https://github.com/d4rckh/gorilla.git /tools/wordlist-generator
cd /tools/wordlist-generator
cargo build --release
# Ones via release downloading
mkdir /tools/ysoserial
wget -q https://github.com/frohoff/ysoserial/releases/latest/download/ysoserial-all.jar -O /tools/ysoserial/ysoserial.jar
wget -q "https://github.com/adoptium/temurin8-binaries/releases/download/jdk8u412-b08/OpenJDK8U-jdk_x64_alpine-linux_hotspot_8u412b08.tar.gz" -O /tools/ysoserial/openjdk8.tar.gz
mkdir /tools/venom-ovh
wget -q https://github.com/ovh/venom/releases/download/v1.0.0-rc.2/venom.linux-amd64 -O /tools/venom-ovh/venom
cd /tools/venom-ovh
chmod +x venom
./venom update
mkdir /tools/jdam
wget -q https://gitlab.com/api/v4/projects/22765596/packages/generic/jdam/0.2.0/jdam-linux-amd64-v0.2.0-alpha -O /tools/jdam/jdam
# Ones via PIP
python -m pip install droopescan regexploit name-that-hash git-dumper pyjks signxml xortool ds-store defaultcreds-cheat-sheet wafw00f zeep
# Ones via GO install system
export GO111MODULE=on
go install github.com/ffuf/ffuf/v2@latest
go install github.com/projectdiscovery/pdtm/cmd/pdtm@latest
go install github.com/hakluke/hakrawler@latest
go install github.com/OJ/gobuster/v3@latest
go install github.com/fullstorydev/grpcurl/cmd/grpcurl@latest
go install github.com/mikefarah/yq/v4@latest
go install github.com/joanbono/gap@latest
go install github.com/d3mondev/puredns/v2@latest
go install github.com/LukaSikic/subzy@latest
go install github.com/bitquark/shortscan/cmd/shortscan@latest
/root/go/bin/pdtm -binary-path /root/go/bin -install-all
/root/go/bin/nuclei -update-templates
/root/go/bin/subzy update
ln -s /root/go/bin/gap /usr/bin/google-api-checker
# One via CARGO install system
cargo install htmlq cargo-cache
# Install dependencies via PIP for tools
for f in $(ls /tools/*/requirements.txt)
do
	python -m pip install -r $f
done
tldextract --update
# Patch for the python package "dnsdumpster"
# See https://github.com/PaulSec/API-dnsdumpster.com
# The version in pypi do not contain the patch to fix the error due to 
# change of the result format returned by dnsdumpster.com
# See https://github.com/PaulSec/API-dnsdumpster.com/commit/fa952c6cbdf32f70ed1af60ac318907898e0e8ac
python -m pip uninstall --yes dnsdumpster
python -m pip install https://github.com/PaulSec/API-dnsdumpster.com/archive/master.zip
# Update default creds DB
creds update
# Setup the list of DNS public resolvers for PureDNS
mkdir -p /root/.config/puredns
cp /tools/dictionaries/dns-resolvers.txt /root/.config/puredns/resolvers.txt
dos2unix /root/.config/puredns/resolvers.txt
# Setup the default configuration profile for HTTPIE
mkdir -p /root/.config/httpie
wget -q -O /root/.config/httpie/config.json https://raw.githubusercontent.com/righettod/toolbox-pentest-web/master/build/httpie-default-configuration.json
dos2unix /root/.config/httpie/config.json
jq -r "." /root/.config/httpie/config.json
# Ensure that all shell and python scripts use Unix EOL
( find /tools/scripts -type f -name "*.sh") | xargs dos2unix
( find /tools/scripts -type f -name "*.py") | xargs dos2unix
# If the flag is specified then install extra software and system packages
if [ "$INSTALL_EXTRA_SOFTWARE_AND_PACKAGES" == "YES" ]
then
	wget -q -O /tools/ssh-username-enum.py https://raw.githubusercontent.com/epi052/cve-2018-15473/refs/heads/master/ssh-username-enum.py
 	chmod +x /tools/ssh-username-enum.py
	apk add --no-cache tmux aws-cli samba-client hydra mysql-client postgresql-client chrony lftp ruby ruby-dev net-snmp-tools rpcbind
	python -m pip install smbclientng ldap3 ssh-audit stomp-py paramiko
	curl -s --output /usr/bin/kubectl -L "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
	chmod +x /usr/bin/kubectl
	kubectl --help
fi
echo 0
