#!/bin/bash
#############################################################################################
# Script to find information composing the CPE identifier for a software (application).
# The REST API exposed by the NATIONAL VULNERABILITY DATABASE (NVD) is used.
#
# References used:
#	https://nmap.org/book/output-formats-cpe.html
#	https://en.wikipedia.org/wiki/Common_Platform_Enumeration
#
# Requirements in terms of software:
# 	apt install jq curl
#
#############################################################################################

# Constants
CPE_TEMPLATE="cpe:2.3:a:%s:%s:%s:*:*:*:*:*:*:*"
VENDOR_SERVICE="https://nvd.nist.gov/rest/public/cpe/vendors?serviceType=vendorList&startsWith="
PRODUCT_SERVICE="https://nvd.nist.gov/rest/public/cpe/products?serviceType=products&vendor="
VERSION_SERVICE="https://nvd.nist.gov/rest/public/cpe/versions?serviceType=versions&product=PRODUCT_NAME&vendor=VENDOR_NAME"

# Entry point
if [ "$#" -lt 1 ]; then
	script_name=$(basename "$0")
	echo "Usage:"
	echo "   $script_name [VENDOR] [PRODUCT] [VERSION]"
	echo ""
	echo "PRODUCT and VERSION are optional."
	echo "If VENDOR + PRODUCT + VERSION are provided then a CPE identifier is generated."
	echo ""
	echo "Call example:"
	echo "    $script_name apache"
	echo "    $script_name apache airflow"
	echo "    $script_name apache airflow 1.0.0"
    exit 1
fi

# Utility functions
function write_step(){
	echo -e "\e[93m$1\e[0m"
}

# Main processing
provided="vendor"
vendor="$1"
product=""
version=""
if [ "$#" -eq 2 ]; then
	product="$2"
	provided="product"
elif [ "$#" -eq 3 ]; then
	product="$2"
	version="$3"
	provided="all"
fi
if [ "$provided" == "vendor" ]
then
	write_step "[+] Verify that the vendor specified is present into the NVD DB..."
	edp="$VENDOR_SERVICE$vendor"
	component_count=$(curl -sk "$edp" | jq -r ".components | length")
	if [ $component_count -eq 0 ]
	then
		echo "Vendor not found!"
		exit 1
	else
		echo "Vendor found."
	fi
	write_step "[+] Products (software) available for the vendor specified:"
	edp="$PRODUCT_SERVICE$vendor"
	curl -sk "$edp" | jq -r ".components[].componentName"
elif [ "$provided" == "product" ]
then
	write_step "[+] Version available for the vendor and product specified:"
	edp=$(echo $VERSION_SERVICE | sed "s/PRODUCT_NAME/$product/g" | sed "s/VENDOR_NAME/$vendor/g")
	curl -sk "$edp" | jq -r ".components[].cpeUri" | rev | cut -d':' -f1 | rev | sort -u
elif [ "$provided" == "all" ]
then
	write_step "[+] Generate the CPE idenfier for the information specified:"
	if [ "$version" == "-" ]
	then
		version="*"
	fi
	printf "$CPE_TEMPLATE\n" "$vendor" "$product" "$version"
fi
exit 0
