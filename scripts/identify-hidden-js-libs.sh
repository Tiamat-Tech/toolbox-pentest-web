#!/bin/bash
###########################################################################################################
# Script to identify JS libs deployed alongside a web application but not referenced
#
# Use package names from this CDN:
#   https://cdnjs.com/api#browse
#
# Use dictionary QUICKHITS from SecLists to identify content in the lib folders identified:
#   https://raw.githubusercontent.com/danielmiessler/SecLists/master/Discovery/Web-Content/quickhits.txt
#
# Dependencies:
#   https://github.com/ffuf/ffuf
#   https://stedolan.github.io/jq/
#   https://curl.se/
###########################################################################################################
####
# Context tunning
FFUF_EXTRA_OPTIONS="-s -c -t 15"
AUTH_TOKEN="X-Test: 123"
COOKIES="Cookie: a=b"
####
# Utilities functions
function write_step(){
    echo -e "\e[93m[+] $1\e[0m"
}
# Constants
PKG_FILE="/tmp/modules.tmp"
DATA_FILE_JSON="/tmp/data.json"
DATA_FILE_TEXT="/tmp/data.tmp"
GLOBAL_RESULTS="/tmp/data_global.json"
WORDS_DICT="/tools/sec-lists/Discovery/Web-Content/raft-small-words-lowercase.txt"
JS_EXTENSIONS=("js" "min.js" "min.js.map" "bundle.min.js.map")
# Entry point
if [ "$#" -lt 1 ]; then
    script_name=$(basename "$0")
    echo "Usage:"
    echo "   $script_name [APP_JS_FOLDER_BASE_URL_WITHOUT_ENDING_SLASH] [PACKAGE_COUNT_TAKEN_FROM_NAMES_JSON_FILE]"
    echo ""
    echo "[i] PACKAGE_COUNT_TAKEN_FROM_NAMES_JSON_FILE is optional and default to all."
    echo ""
    echo "Call example:"
    echo "    $script_name https://myapp.com/js/vendor"
    echo "    $script_name https://myapp.com/js/vendor 50000"
    exit 1
fi
APP_JS_FOLDER_BASE_URL=$1
PATH_TO_NAMES_FILE="/tools/dictionaries/js-libraries-names.txt"
PATH_TO_SECLISTS_QUICKHITS_DICT_TXT_FILE="/tools/sec-lists/Discovery/Web-Content/quickhits.txt"
if [ "$#" -eq 2 ]; then
    PKG_LIMIT=$2
else
    PKG_LIMIT=3000000
fi
# Step 01
write_step "Filter package list to the first $PKG_LIMIT having a package name..."
cat $PATH_TO_NAMES_FILE | head -n $PKG_LIMIT > $PKG_FILE
# PreStep 02a
# Ensure that a discrepancy factor, via the HTTP response variation, exists to identify if a directory exists or not
skip_step2a="NO"
respA=$(curl -sk -o /dev/null -H "$AUTH_TOKEN" -H "$COOKIES" -w "%{http_code}" "$APP_JS_FOLDER_BASE_URL/")
respB=$(curl -sk -o /dev/null -H "$AUTH_TOKEN" -H "$COOKIES" -w "%{http_code}" "$APP_JS_FOLDER_BASE_URL-$RANDOM/")
if [ "$respA" == "$respB" ];
then
	# No discrepancy factor
	skip_step2a="YES"
fi
# Step 02a
if [ $skip_step2a == "NO" ];
then
	write_step "Search for presence of folder with the package name..."
	ffuf $FFUF_EXTRA_OPTIONS -H "$AUTH_TOKEN" -H "$COOKIES" -of json -o $DATA_FILE_JSON -w $PKG_FILE -mc $respA -u "$APP_JS_FOLDER_BASE_URL/FUZZ/"
	jq --raw-output ".results[].input.FUZZ" $DATA_FILE_JSON > $DATA_FILE_TEXT
else
	rm -f $DATA_FILE_TEXT 2>/dev/null
	write_step "No discrepancy factor found for folder existence => search for folder skipped!"
	write_step "Search for presence of a js file with the package name with the '.js' extension in a folder having the package name..."
	ffuf $FFUF_EXTRA_OPTIONS -H "$AUTH_TOKEN" -H "$COOKIES" -w $PKG_FILE -mc 200 -u "$APP_JS_FOLDER_BASE_URL/FUZZ/FUZZ.js"
fi
# Step 02b
for js_extension in "${JS_EXTENSIONS[@]}"
do 
	write_step "Search for presence of a js file with the package name with the '.$js_extension' extension..."
	ffuf $FFUF_EXTRA_OPTIONS -H "$AUTH_TOKEN" -H "$COOKIES" -w $PKG_FILE -mc 200 -u "$APP_JS_FOLDER_BASE_URL/FUZZ.$js_extension"
done
# Step 02c
cat "$WORDS_DICT" | grep -Fv "." | sort -u > $PKG_FILE
for js_extension in "${JS_EXTENSIONS[@]}"
do 
	write_step "Search for presence of a js file with a name taken from the dict '$(basename $WORDS_DICT)' with the '.$js_extension' extension..."
	ffuf $FFUF_EXTRA_OPTIONS -H "$AUTH_TOKEN" -H "$COOKIES" -w $PKG_FILE -mc 200 -u "$APP_JS_FOLDER_BASE_URL/FUZZ.$js_extension"
done
# Perform addtional steps only lib folders were found
if [ -s $DATA_FILE_TEXT ]; then
	# Step 03
	write_step "Search for content into lib folders identified..."
	ffuf $FFUF_EXTRA_OPTIONS -H "$AUTH_TOKEN" -H "$COOKIES" -of json -o $GLOBAL_RESULTS -w $DATA_FILE_TEXT:FLDER -w $PATH_TO_SECLISTS_QUICKHITS_DICT_TXT_FILE:FLE -mc 200,301,302,303,401 -u "$APP_JS_FOLDER_BASE_URL/FLDER/FLE"
	# Step 04
	write_step "Valid URL identified:"
	jq --raw-output ".results[].url" $GLOBAL_RESULTS
fi
# Step 05
write_step "Cleanup..."
rm $PKG_FILE 2>/dev/null
rm $DATA_FILE_JSON 2>/dev/null
rm $DATA_FILE_TEXT 2>/dev/null
rm $GLOBAL_RESULTS 2>/dev/null
exit 0
