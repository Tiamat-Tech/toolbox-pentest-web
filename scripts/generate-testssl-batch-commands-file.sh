#!/bin/bash
################################################################
# Script to generate a batch commands file for TestSSL
#
# Requirement software:
#   https://github.com/projectdiscovery/httpx
################################################################
# Constants
BASE_TESTSSL_CMD="-s -p -U --quiet -oJ"
BATCH_COMMAND_FILE="testssl-batch-commands.txt"
# Utility functions
function write_step(){
	echo -e "\e[93m$1\e[0m"
}
# Entry point
if [ "$#" -lt 1 ]; then
    script_name=$(basename "$0")
    echo "Usage:"
    echo "   $script_name [FILE_WITH_LIST_OF_IP_OR_DOMAINS]"
    echo ""
    echo "Call example:"
    echo "    $script_name target.txt"
    exit 1
fi
# Main processing
source="$1"
write_step "[*] Check IP and domains provided for TLS based services..."
httpx -l $source -duc -silent -p https:443,8443,9443,9043 > $source.tmp
write_step "[*] Generate the commands file..."
rm $BATCH_COMMAND_FILE 2>/dev/null
while IFS= read -r entry
do
    logfilename=$(tr -dc A-Za-z0-9 </dev/urandom | head -c 15)
    echo "$BASE_TESTSSL_CMD $logfilename.json $entry" >> $BATCH_COMMAND_FILE
done < "$source.tmp"
write_step "[V] Commands file genered into file '$BATCH_COMMAND_FILE'."
rm $source.tmp