#!/bin/bash
###
# Script to discover hidden content on a web site/app.
# Cf https://github.com/ffuf/ffuf#usage
# Use -fl X to skip responses with X number of lines
#     -fs X to skip responses with a response size of X bytes
#     -fw X to skip responses with X words
#     -fl 12,25 to skip responses with 12 or 25 number of lines (same syntax for 'fs' and 'fw')
###
EXTRA_FFUF_OPTS=""
COOKIES="Cookie: a=b"
AUTHENTICATION_HEADER="X-Origin: RIGHETTOD"
###
USER_AGENT="User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/126.0.6478.57"
IGNORE_HTTP_CODES="400,401,403,404"
THREAD_COUNT="10"
TIMEOUT=30
PROXY=""
###
DICT_HOME="/tools/sec-lists/Discovery/Web-Content"
REPORT_HOME="/tools/reports"
EXTENSIONS=".asp,.aspx,.jsp,.php,.html,.htm,.js,.min.js,.js.map,.txt,.json,.config.js,-config.js,.properties,.env,.config,.yml"
###
if [ "$PROXY" != "" ];
then
	ffuf_proxy="-x $PROXY"
	curl_proxy="--proxy $PROXY"
else
	ffuf_proxy=""
	curl_proxy=""
fi
base_target=$1
# Phase 1
echo -e "\e[93m[PHASE 1] Identify directories and search content into them using 'common.txt' ...\e[0m"
opts=" $EXTRA_FFUF_OPTS $ffuf_proxy -fc $IGNORE_HTTP_CODES -c -ic -timeout $TIMEOUT -t $THREAD_COUNT "
katana -silent -disable-update-check -depth 10 -known-files all -automatic-form-fill -ignore-query-params -js-crawl -crawl-duration 5m -field dir -H "$AUTHENTICATION_HEADER" -H "$COOKIES" -u $base_target | sort -u > $REPORT_HOME/dir.txt
cat $REPORT_HOME/dir.txt | sed -e 's/^.//' -e 's/.$//' > $REPORT_HOME/dir.tmp
mv $REPORT_HOME/dir.tmp $REPORT_HOME/dir.txt
dir_count=$(wc -l $REPORT_HOME/dir.txt | cut -d' ' -f1)
if [ $dir_count -ne 0 ]
then
	ffuf $opts -w $REPORT_HOME/dir.txt:FLD -w $DICT_HOME/common.txt:FLE -u "$base_target/FLD/FLE" -H "$COOKIES" -H "$AUTHENTICATION_HEADER" -H "$USER_AGENT"
else
	echo "No directory found."
fi
# Phase 2
dict="$DICT_HOME/../../Fuzzing/environment-identifiers.txt"
entries_count=$(wc -l $dict | cut -d' ' -f1)
echo -e "\e[93m[PHASE 2] Test using SecLists dictionary '$(basename $dict)' ($entries_count entries) for variation of the '.env' file ...\e[0m"
opts=" $EXTRA_FFUF_OPTS $ffuf_proxy -fc $IGNORE_HTTP_CODES -r -c -ic -timeout $TIMEOUT -t $THREAD_COUNT "
ffuf $opts -w $dict -u $base_target/.env.FUZZ -H "$COOKIES" -H "$AUTHENTICATION_HEADER" -H "$USER_AGENT"
# Phase 3
opts=" $EXTRA_FFUF_OPTS -recursion -recursion-depth 5 $ffuf_proxy -fc $IGNORE_HTTP_CODES -r -c -ic -timeout $TIMEOUT -t $THREAD_COUNT "
dicts=("quickhits.txt" "common.txt" "graphql.txt" "swagger.txt" "spring-boot.txt" "axis.txt" "Common-DB-Backups.txt" "versioning_metafiles.txt" "ntlm-directories.txt" "raft-small-words-lowercase.txt")
for dict in ${dicts[@]}; do
	if [ "$dict" != "raft-small-words-lowercase.txt" ];
	then
		entries_count=$(wc -l $DICT_HOME/$dict | cut -d' ' -f1)
		echo -e "\e[93m[PHASE 3] Test using SecLists dictionary '$dict' ($entries_count entries) ...\e[0m"	
		ffuf $opts -w $DICT_HOME/$dict -u $base_target/FUZZ -H "$COOKIES" -H "$AUTHENTICATION_HEADER" -H "$USER_AGENT"
	else
		# Clean the origin dict a little bit
		grep -Ev '[\.\s@\/]' $DICT_HOME/$dict | grep -Ev '^[0-9]' | sort -u > /tmp/$dict
		entries_count=$(wc -l /tmp/$dict | cut -d' ' -f1)
		echo -e "\e[93m[PHASE 3] Test using SecLists dictionary '$dict' cleaned a little bit ($entries_count entries) ...\e[0m"			
		ffuf $opts -e $EXTENSIONS -w /tmp/$dict -u $base_target/FUZZ -H "$COOKIES" -H "$AUTHENTICATION_HEADER" -H "$USER_AGENT"
	fi
done
