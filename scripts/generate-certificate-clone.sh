#!/bin/bash
##############################################################
# Script to clone an X509 certificate.
#
# System dependencies to install via the package manager:
#   apt install openssl
##############################################################
if [ "$#" -lt 1 ]; then
    script_name=$(basename "$0")
    echo "Usage:"
    echo "   $script_name [SOURCE_CERTIFICATE_PEM_FILE]"
    echo ""
    echo "Call example:"
    echo "    $script_name /tmp/cert.pem"
    exit 1
fi
base_cert=$1
hash_algo="-sha256"
clone_cert_named="clone-certificate.pem"
clone_cert_private_key_name="clone-private_key.pem"

function write_step (){
    echo -e "\e[93m[+] $1\e[0m"
}

function extract_cert_field(){
    field=$1
    cert_file=$2
    openssl x509 -text -in $cert_file -inform pem -text | grep "$field:" | cut -d':' -f2
}

function format_subject_field(){
    subject=$(echo $1 | sed 's/ = /=/g' | sed 's/, /,/g' | tr ',' '/')
    subject=$(echo ${subject:0})
    echo $subject    
}

write_step "Extract subject..."
subject=$(extract_cert_field "Subject" $base_cert)
subject=$(format_subject_field "$subject")
echo $subject
write_step "Extract public key algorithm..."
algo=$(extract_cert_field "Public Key Algorithm" $base_cert | tr -d ' ' | tr ',' '/')
key_size=""
if [ $algo == "rsaEncryption" ];
then
    key_size=$(extract_cert_field "Public-Key" $base_cert | cut -d'(' -f2 | cut -d ' ' -f1)
else
    key_size=$(extract_cert_field "ASN1 OID" $base_cert | tr -d ' ')
fi
echo "$algo ($key_size)."
write_step "Generate the certificate clone and its corresponding private key..."
if [ $algo == "rsaEncryption" ];
then
    openssl genrsa -out clone-private_key.pem $key_size 
else
    openssl ecparam -name $key_size -genkey -noout -out $clone_cert_private_key_name
fi
openssl req -new -x509 -key $clone_cert_private_key_name -out $clone_cert_named -subj "/$subject" $hash_algo
ls -l clone-*
write_step "Subject of the cloned certificate:"
subject=$(extract_cert_field "Subject" $clone_cert_named)
subject=$(format_subject_field "$subject")
echo $subject
