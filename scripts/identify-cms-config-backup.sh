#!/bin/bash
###
# Script to discover a backup file of the CMS configuration file.
# Cf https://github.com/ffuf/ffuf#usage
# Use -fl X to skip responses with X number of lines
#     -fs X to skip responses with a response size of X bytes
#     -fw X to skip responses with X words
#     -fl 12,25 to skip responses with 12 or 25 number of lines (same syntax for 'fs' and 'fw')
###
## CMS reference paths: 
# Cf https://github.com/danielmiessler/SecLists/blob/master/Discovery/Web-Content/CMS/cms-configuration-files.txt
###
function write_step(){
    echo -e "\e[93m[+] $1\e[0m"
}
base_target=$1
###
EXTRA_FFUF_OPTS=""
COOKIES="Cookie: a=b"
AUTHENTICATION_HEADER="X-Origin: RIGHETTOD"
PROXY=""
THREAD_COUNT="10"
YEAR_BACK=2
if [ "$PROXY" != "" ];
then
	ffuf_proxy="-x $PROXY"
else
	ffuf_proxy=""
fi
###
DICT_HOME="/tools/sec-lists/Discovery/Web-Content"
BACKUP_EXTENSION_DICTS=("web-mutations.txt" "raft-large-extensions-lowercase.txt")
CMS_CONFIG_BASE_PATH="/tmp/cms.tmp"
EXTENSION_DICT="/tmp/ext.tmp"
OPTS=" $EXTRA_FFUF_OPTS $ffuf_proxy -mc 200 -c -ic -timeout 30 -t $THREAD_COUNT "
###
write_step "Load the dict of CMS configuration files..."
grep -Ev "^#" "$DICT_HOME/CMS/cms-configuration-files.txt" > $CMS_CONFIG_BASE_PATH
wc -l $CMS_CONFIG_BASE_PATH
write_step "Generate the dict of extensions..."
python /tools/scripts/generate-backup-extensions-dict.py -y $YEAR_BACK -o $EXTENSION_DICT 1>/dev/null
for d in ${BACKUP_EXTENSION_DICTS[@]}; do
	cat $DICT_HOME/$d >> $EXTENSION_DICT	
done
cat $EXTENSION_DICT | sort -u > $EXTENSION_DICT.tmp
mv $EXTENSION_DICT.tmp $EXTENSION_DICT
wc -l $EXTENSION_DICT
while read p; do 
	write_step "Search using base path '$p'..."
	t="$base_target/$p"
	ffuf $OPTS -w $EXTENSION_DICT:EXT -H "$COOKIES" -H "$AUTHENTICATION_HEADER" -u "$t"EXT	
done < $CMS_CONFIG_BASE_PATH
